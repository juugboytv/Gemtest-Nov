<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Geminus - Aetherial Shard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://css.gg/css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, orderBy, limitToLast, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
window.firebase = {
    initializeApp,
    getAuth,
    signInAnonymously,
    getFirestore,
    doc,
    setDoc,
    getDoc,
    updateDoc,
    collection,
    addDoc,
    query,
    orderBy,
    limitToLast,
    onSnapshot,
    serverTimestamp
};
</script>
<style>
/* --- Base & Typography (Theme-Independent) --- */
html, body {
    height: 100%;
    overflow: hidden;
}
body {
    font-family: 'Inter', sans-serif;
    background-color: #121212;
    -webkit-user-select: none;
    user-select: none;
    touch-action: manipulation;
    transition: background-color 0.5s;
}
.font-orbitron {
    font-family: 'Orbitron', sans-serif;
}
/* --- Animated Background --- */
#smoke-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: -1;
    pointer-events: none;
    opacity: 0.5;
}
/* --- AETHERIAL SHARD THEME (CYAN) --- */
body.theme-aetherial-shard {
    --highlight-color: #22d3ee;
    --highlight-color-rgb: 34, 211, 238;
    --glow-color: #67e8f9;
    --text-primary: #f0f0f0;
    --text-secondary: #a0a0a0;
    --panel-bg-color: rgba(30, 35, 45, 0.65);
    --input-bg: rgba(0, 0, 0, 0.4);
    --border-color-main: rgba(34, 211, 238, 0.4);
    --border-color-pulse: rgba(103, 232, 249, 0.7);
    --hp-color: #22c55e;
    --name-color: var(--highlight-color);
    --gold-color: #facc15;
    --destroy-color: #f87171;
    --glow-caster: #3b82f6;
    --glow-fighter: #ef4444;
    --glow-misc: #22c55e;
    --glow-full: #ef4444;
    --glow-partial: #3b82f6;
}
@keyframes pulse-border-cyan {
    0%, 100% { border-color: var(--border-color-main); box-shadow: 0 0 15px rgba(34, 211, 238, 0.2), 0 4px 30px rgba(0, 0, 0, 0.6);
    }
    50% { border-color: var(--border-color-pulse); box-shadow: 0 0 25px rgba(103, 232, 249, 0.3), 0 4px 30px rgba(0, 0, 0, 0.6); }
}
@keyframes pulse-main-tab-glow-cyan {
    0%, 100% { border-bottom-color: var(--highlight-color); text-shadow: 0 0 8px var(--highlight-color); }
    50% { border-bottom-color: var(--glow-color); text-shadow: 0 0 12px var(--glow-color); }
}
body.theme-aetherial-shard .glass-panel { animation-name: pulse-border-cyan; }
body.theme-aetherial-shard .main-tab-button.active { animation-name: pulse-main-tab-glow-cyan; }
body.theme-aetherial-shard .glass-panel {
    background-image: linear-gradient(var(--panel-bg-color), var(--panel-bg-color)),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4' viewBox='0 0 4 4'%3E%3Cpath fill='%23ffffff' fill-opacity='0.02' d='M1 3h1v1H1V3zm2-2h1v1H3V1z'%3E%3C/path%3E%3C/svg%3E");
}
body.theme-aetherial-shard .gem-item.selected { border-color: var(--glow-color); box-shadow: 0 0 10px var(--glow-color); }
/* --- MOLTEN CORE THEME (ORANGE/RED) --- */
body.theme-molten-core {
    --highlight-color: #f97316;
    --highlight-color-rgb: 249, 115, 22;
    --glow-color: #ef4444;
    --text-primary: #f0f0f0;
    --text-secondary: #a0a0a0;
    --panel-bg-color: rgba(20, 20, 22, 0.85);
    --input-bg: rgba(0, 0, 0, 0.4);
    --border-color-main: rgba(249, 115, 22, 0.4);
    --border-color-pulse: rgba(239, 68, 68, 0.7);
    --hp-color: #E53935;
    --name-color: var(--highlight-color);
    --gold-color: #facc15;
    --destroy-color: #f87171;
    --glow-caster: #3b82f6;
    --glow-fighter: #ef4444;
    --glow-misc: #22c55e;
    --glow-full: #ef4444;
    --glow-partial: #3b82f6;
}
@keyframes pulse-border-molten {
    0%, 100% { border-color: var(--border-color-main); box-shadow: 0 0 15px rgba(249, 115, 22, 0.2), 0 4px 30px rgba(0, 0, 0, 0.6);
    }
    50% { border-color: var(--border-color-pulse); box-shadow: 0 0 25px rgba(239, 68, 68, 0.4), 0 4px 30px rgba(0, 0, 0, 0.6); }
}
@keyframes pulse-main-tab-glow-molten {
    0%, 100% { border-bottom-color: var(--highlight-color); text-shadow: 0 0 8px var(--highlight-color); }
    50% { border-bottom-color: var(--glow-color); text-shadow: 0 0 12px var(--glow-color); }
}
body.theme-molten-core .glass-panel { animation-name: pulse-border-molten; }
body.theme-molten-core .main-tab-button.active { animation-name: pulse-main-tab-glow-molten; }
body.theme-molten-core .glass-panel { background: var(--panel-bg-color); }
body.theme-molten-core .gem-item.selected { border-color: var(--glow-color); box-shadow: 0 0 10px var(--glow-color); }
/* --- Core UI Components (Theme-Dependent Styles) --- */
body { color: var(--text-primary); }
/* Text Glow Styles */
.text-glow-label {
    color: var(--highlight-color);
    font-weight: 700;
    text-shadow: 0 0 8px var(--highlight-color);
}
.text-glow-subtle {
    color: var(--text-primary);
    text-shadow: 0 0 5px var(--highlight-color);
}
.glass-panel {
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    border: 1px solid;
    animation-duration: 4s;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
}
.glass-button {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color-main);
    color: var(--text-primary);
    transition: all 0.2s ease-in-out;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    font-family: 'Orbitron', sans-serif;
    text-shadow: 0 0 5px var(--highlight-color);
}
.glass-button:not(:disabled):hover, .glass-button.active {
    background: rgba(var(--highlight-color-rgb), 0.15);
    border-color: var(--highlight-color);
    transform: translateY(-2px);
    color: var(--highlight-color);
    text-shadow: 0 0 10px var(--highlight-color);
}
.glass-button:disabled {
    background: rgba(60, 60, 60, 0.4) !important;
    border-color: rgba(100, 100, 100, 0.8) !important;
    cursor: not-allowed;
    color: #6b7280 !important;
    text-shadow: none !important;
    box-shadow: none !important;
    animation: none;
}
.glass-button:not(:disabled):active { transform: translateY(1px) scale(0.98); }
/* --- Scrollbars & Progress Bars --- */
.progress-bar-track { background-color: rgba(0,0,0,0.5); border-radius: 9999px; overflow: hidden; border: 1px solid rgba(0,0,0,0.7); }
.progress-bar-fill { border-radius: 9999px; height: 100%; transition: width 0.3s ease-out; }
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--border-color-main); border-radius: 3px; }
.custom-scrollbar-x::-webkit-scrollbar { height: 4px; }
.custom-scrollbar-x::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar-x::-webkit-scrollbar-thumb { background-color: var(--border-color-main); border-radius: 2px; }
/* --- Main Layout & Tabs --- */
#main-content { transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; }
#main-content.focused { position: fixed; inset: 0; z-index: 50; width: 100vw; height: 100vh; border-radius: 0; padding: 0; }
.main-tab-button {
    flex-shrink: 0; font-family: 'Orbitron', sans-serif; font-size: 0.8rem;
    padding: 0.75rem 1rem; background: transparent; border: none;
    border-bottom: 3px solid transparent; color: var(--text-secondary);
    cursor: pointer; transition: color 0.3s;
}
.main-tab-button.active {
    color: var(--highlight-color);
    animation-duration: 4s;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
}
.main-tab-panel { display: none; }
.main-tab-panel.active { display: block; }
/* --- Modals & Toasts --- */
.modal-backdrop {position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 60; padding: 1rem;
}
#toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; font-weight: 600;
    transition: bottom 0.5s ease-in-out; z-index: 100; border: 1px solid; }
.toast-error { background-color: rgba(255, 80, 80, 0.2); border-color: #ff5050; color: #ff5050; }
.toast-success { background-color: rgba(var(--highlight-color-rgb), 0.2); border-color: var(--highlight-color); color: var(--highlight-color); }
@keyframes flash { 0% { color: #fff; text-shadow: 0 0 10px #fff; } 50% { color: var(--highlight-color);
    text-shadow: 0 0 15px var(--highlight-color); } 100% { color: #fff; text-shadow: none; } }
.flash-update { animation: flash 0.5s ease-out; }
#stat-info-modal { position: fixed; inset: 0; z-index: 1001; background-color: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; }
#stat-info-backdrop { position: absolute; inset: 0; }
.stat-info-content { background: var(--panel-bg-color); border: 1px solid var(--border-color-main); padding: 1.5rem; border-radius: 0.5rem; max-width: 300px; text-align: center; }
#item-action-modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 998; display: none; }
#item-action-modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 999; width: 90%; max-width: 320px; display: none; }
.item-action-modal-body { text-align: center; }
.item-action-modal-body .item-name { font-family: 'Orbitron', sans-serif; font-size: 1.25rem; margin-bottom: 0.25rem; }
.item-action-modal-body .item-type { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem; }
.item-action-modal-body .item-stat { font-size: 1rem; margin-bottom: 0.75rem; }
.item-action-modal-body .item-stat-label { color: var(--text-secondary); }
.item-action-modal-body .item-stat-value { font-weight: 600; color: var(--text-primary); }
/* --- Chat UI --- */
.footer-tab-button.active { color: var(--highlight-color); font-weight: bold; }
.footer-chat-input { background: var(--input-bg); border: 1px solid var(--border-color-main); color: var(--text-primary); }
.footer-chat-input::placeholder { color: var(--text-secondary); }
.footer-chat-input:focus {outline: none; border-color: var(--highlight-color); }
.sidebar-closed { transform: translateX(-100%); }
.sidebar-open { transform: translateX(0); }
.chat-bubble { background: rgba(10, 15, 20, 0.7) !important; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); border: 1px solid; position: relative; }
.chat-bubble-user { border-color: var(--border-color-main); }
.chat-bubble-other { border-color: rgba(var(--highlight-color-rgb), 0.2); }
.reply-icon { cursor: pointer; opacity: 0.4; transition: opacity 0.2s; }
.message-wrapper:hover .reply-icon { opacity: 1; }
.reply-quote { background: rgba(0,0,0,0.3); border-left: 2px solid var(--highlight-color); padding: 6px 10px; border-radius: 4px; margin-bottom: 8px; font-size: 0.8rem; }
.avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color-main); }
.btn-primary { background-color: transparent; border: 2px solid var(--highlight-color); color: var(--highlight-color); transition: all 0.3s ease; }
.btn-primary:hover { background-color: var(--highlight-color); color: #000; box-shadow: 0 0 15px var(--highlight-color); }
#chat-modal .tab { cursor: pointer; transition: all 0.2s; border-bottom: 3px solid transparent; padding-bottom: 8px; color: var(--text-secondary); }
#chat-modal .tab.active { color: var(--highlight-color); border-bottom-color: var(--highlight-color); animation-name: pulse-main-tab-glow-cyan; animation-duration: 4s; animation-iteration-count: infinite; }
body.theme-molten-core #chat-modal .tab.active { animation-name: pulse-main-tab-glow-molten; }
#chat-modal input, #modal-container input { background: var(--input-bg); border: 1px solid var(--border-color-main); border-radius: 0.5rem; padding: 0.75rem 1rem; transition: all 0.2s;
    color: var(--text-primary); }
#chat-modal input::placeholder, #modal-container input::placeholder { color: var(--text-secondary); }
#chat-modal input:focus, #modal-container input:focus {outline: none; border-color: var(--highlight-color); box-shadow: 0 0 10px rgba(var(--highlight-color-rgb), 0.4); }
/* --- Stats Accordion Styles --- */
.stat-accordion-item { background: rgba(0,0,0,0.2); border-radius: 0.5rem; margin-bottom: 0.75rem; overflow: hidden; border: 1px solid rgba(var(--highlight-color-rgb), 0.15); }
.stat-accordion-header { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0.75rem 1rem; background: rgba(var(--highlight-color-rgb), 0.05); cursor: pointer; border: none;
    text-align: left; }
.stat-accordion-header h3 { font-family: 'Orbitron', serif; font-size: 1.1rem; }
.accordion-arrow { transition: transform 0.3s ease; color: var(--text-secondary); }
.stat-accordion-item.open .accordion-arrow { transform: rotate(90deg); }
.stat-accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; padding: 0 1rem; }
.stat-accordion-item.open .stat-accordion-content { max-height: 1000px; padding: 1rem; }
.stat-line { display: flex; align-items: center; padding: 0.5rem 0; font-size: 0.9rem; border-bottom: 1px solid rgba(var(--highlight-color-rgb), 0.1); }
.stat-line:last-child { border-bottom: none; }
.stat-line .stat-name { flex-grow: 1; }
.info-btn { background: none; border: 1px solid var(--text-secondary); color: var(--text-secondary); border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; line-height: 18px;
    text-align: center; cursor: pointer; margin-left: 0.75rem; transition: all 0.2s; }
.info-btn:hover { background-color: var(--highlight-color); border-color: var(--highlight-color); color: black; }
.attr-btn { background: rgba(var(--highlight-color-rgb), 0.2); border: 1px solid var(--border-color-main); color: var(--highlight-color); border-radius: 6px; width: 28px; height: 28px; font-weight: bold;
    cursor: pointer; transition: all 0.2s; margin-left: 0.5rem; font-size: 1.2rem; }
.attr-btn:hover:not(:disabled) { background: rgba(var(--highlight-color-rgb), 0.4); }
.attr-btn:disabled { background: rgba(75, 85, 99, 0.2); border-color: #4b5563; color: #6b7280; cursor: not-allowed; }
/* --- Inventory & Gem Grid Styles --- */
.inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 0.75rem; }
.inventory-slot { position: relative; width: 100%; padding-bottom: 100%; height: 0; border: 1px solid var(--border-color-main); border-radius: 0.375rem; background: rgba(0,0,0,0.4); cursor: pointer;
    transition: all 0.2s; }
.inventory-slot:hover { border-color: var(--highlight-color); transform: translateY(-2px); }
.inventory-slot img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; padding: 8px; }
.item-label { position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.7); font-size: 0.6rem; padding: 1px 3px; border-radius: 3px; }
.gem-pouch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(64px, 1fr)); gap: 0.5rem; }
.gem-item { position: relative; border: 2px solid; border-radius: 0.375rem; background: rgba(0,0,0,0.2); cursor: pointer; aspect-ratio: 1 / 1; display: flex;
    align-items: center; justify-content: center; transition: all 0.2s; }
.gem-item:hover { transform: scale(1.1); }
.gem-item.selected-for-socket { box-shadow: 0 0 12px var(--glow-color); transform: scale(1.1); }
.gem-item .item-label { position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.7); font-size: 0.6rem; padding: 1px 3px; border-radius: 3px; color: var(--text-primary);
}
.editor-input { background-color: rgba(0,0,0,0.3); border: 1px solid var(--border-color-main); color: var(--text-primary); padding: 6px 10px; border-radius: 6px; width: 100%; font-size: 14px;
    transition: all 0.2s ease; }
.editor-input:focus { outline: none; border-color: var(--highlight-color); box-shadow: 0 0 8px var(--highlight-color); }
/* --- NEW Gem Overlay System --- */
.gem-overlays-container {
    position: absolute;
    top: 4px; left: 4px; right: 4px;
    height: auto;
    display: flex;
    justify-content: space-between;
    pointer-events: none;
}
.gem-overlay {
    padding: 1px 4px;
    font-size: 0.65rem;
    font-weight: bold;
    color: white;
    border-radius: 4px;
    text-shadow: 1px 1px 2px black;
    border: 1px solid rgba(0,0,0,0.5);
}
.gem-overlay.fighter { background-color: var(--glow-fighter); }
.gem-overlay.caster { background-color: var(--glow-caster); }
.gem-overlay.misc { background-color: var(--glow-misc); }
.item-tier-label { position: absolute; bottom: 4px; right: 4px; background: var(--gold-color); font-size: 0.7rem; font-weight: bold; padding: 1px 5px; border-radius: 4px;
    color: #1f2937; }
/* --- Equipment Grid Styles --- */
.equipment-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
.equipment-slot-wrapper { background-color: transparent; border-radius: 0.5rem; padding: 0.5rem; border: 2px solid transparent; }
.equipment-slot-title { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.8rem; }
.equipment-slot-content { display: flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 0.375rem; min-height: 60px; padding: 4px; position: relative; background-color: rgba(0,0,0,0.2);
    cursor:pointer; border: 1px solid transparent; transition: all 0.2s; }
.equipment-slot-content:hover { border-color: var(--highlight-color); }
/* --- HUD & Mini-Map Styles --- */
#player-status-container .info-label { margin-right: 0.5rem; }
#player-status-container .name-value { color: var(--name-color); font-weight: bold; }
#mini-map-panel { width: 120px; height: 120px; cursor: pointer; }
#mini-map-container { width: 100%; height: 100%; position: relative; }
#mini-map-canvas { width: 100%; height: 100%; }
#toggle-controls-btn { position: absolute; right: 8px; bottom: 8px; z-index: 10; }
/* --- Combat UI --- */
#combat-stats-container { display: grid; grid-template-columns: auto 1fr auto 1fr; gap: 0.1rem 1rem; font-size: 0.75rem; }
.log-player { color: #84cc16; } /* lime-500 */
.log-enemy { color: #ef4444; font-weight: bold; } /* red-500 */
.log-system { color: var(--text-secondary); }
.log-gold { color: #eab308; } /* yellow-500 */
.log-xp { color: #38bdf8; } /* sky-400 */
.log-loot-item { color: #a855f7; } /* purple-500 */
.log-loot-gem { color: var(--highlight-color); }
/* --- D-Pad and Interaction Key Styles --- */
.game-key { display: flex; align-items: center; justify-content: center; font-family: 'Orbitron', sans-serif; font-weight: 900; color: var(--highlight-color); background: var(--panel-bg-color);
    border: 2px solid var(--border-color-main); border-radius: 8px; cursor: pointer; user-select: none; transition: all 0.1s ease-in-out; text-shadow: 0 0 8px var(--highlight-color); }
.move-key { width: 50px; height: 50px; font-size: 24px; }
.move-key svg { width: 1.2em; height: 1.2em; fill: currentColor; }
.d-pad-controls { display: grid; grid-template-areas: ". up ." "left down right"; gap: 10px; }
#key-up, .key-up { grid-area: up; }
#key-left, .key-left { grid-area: left; }
#key-down, .key-down { grid-area: down; }
#key-right, .key-right { grid-area: right; }
#key-interact, .key-interact { width: 170px; height: 50px; font-size: 18px; font-weight: 700; margin-top: 10px; }
.game-key.pressed { background: rgba(10, 10, 12, 0.85); border-color: var(--glow-color); transform: scale(0.95);
    box-shadow: 0 0 15px var(--glow-color), 0 0 20px rgba(0,0,0,0.6) inset; color: var(--glow-color); }
/* --- Footer Controls Toggle --- */
#footer-section { transition: all 0.4s ease-in-out; }
#communication-panel { flex-grow: 1; transition: all 0.4s ease-in-out; }
#controls-panel { flex-shrink: 0; transition: all 0.4s ease-in-out; transform-origin: right; }
#footer-section.controls-hidden #controls-panel { max-width: 0px; opacity: 0; transform: scaleX(0.5); padding: 0; margin: 0; border: none; overflow: hidden; }
/* --- Layout Edit Mode Styles --- */
.layout-edit-mode .tappable-section,
.layout-edit-mode .tappable-tab { cursor: pointer; border: 2px dashed var(--highlight-color) !important; animation: none !important; transition: transform 0.2s, box-shadow 0.2s; }
.layout-selected { border: 2px solid var(--glow-color) !important; box-shadow: 0 0 15px var(--glow-color) !important; transform: scale(1.02); }
/* RESIZE FIX: Ensure sections can grow and shrink properly */
#layout-container > .tappable-section {
    transition: flex 0.3s ease-in-out;
}
</style>
</head>
<body class="bg-black text-gray-200">
<canvas id="smoke-canvas"></canvas>
<div id="game-container" class="h-full">
<div id="game-hud-screen" class="relative z-10 h-full hidden">
<div id="layout-container" class="max-w-md mx-auto h-full flex flex-col p-2 gap-2">
<div id="hud-container" class="tappable-section" data-order="1">
<header id="hud-section" class="relative glass-panel p-3 rounded-lg flex justify-between items-center flex-shrink: 0; gap-2">
<section id="player-status-panel" class="flex-1">
<div id="player-status-container" class="flex flex-col space-y-1">
<p class="font-orbitron text-base name-value text-glow-label" id="player-name-level-value">Player Lvl: 1</p>
<p class="text-xs"><span class="info-label text-glow-label">Race:</span><span class="info-value text-glow-subtle" id="player-race-value"></span></p>
<p class="text-xs"><span class="info-label text-glow-label">A-Spec:</span><span class="info-value text-glow-subtle" id="player-aspec-value"></span></p>
<p class="text-xs"><span class="info-label text-glow-label">Zone:</span><span class="info-value text-glow-subtle" id="zone-name-value"></span></p>
<p class="text-xs text-glow-label" id="player-coords-value">(0,0)</p>
</div>
</section>
<section id="mini-map-panel" class="mr-12">
<div id="mini-map-container">
<div class="absolute -inset-1 rounded-full border border-dashed border-orange-500/30 animate-spin" style="animation-duration: 20s; animation-timing-function: linear;"></div>
<div class="relative w-full h-full rounded-full overflow-hidden glass-panel border-2 border-[var(--border-color-main)]">
<canvas id="mini-map-canvas"></canvas>
</div>
</div>
</section>
<button id="toggle-controls-btn" class="glass-button w-11 h-11 rounded-full text-2xl !p-0">ðŸŽ®</button>
</header>
</div>
<div id="main-content-container" class="tappable-section flex-grow flex flex-col overflow-hidden" data-order="2">
<section id="main-content-panel" class="flex-grow flex flex-col overflow-hidden">
<main id="main-content" class="flex-grow flex flex-col overflow-hidden glass-panel rounded-lg relative">
<button id="focus-mode-btn" class="absolute bottom-2 right-2 w-8 h-8 rounded-full bg-red-600 border border-white/30 flex items-center justify-center cursor-pointer transition-colors hover:bg-red-500 z-50" title="Toggle Focus Mode">
<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5"></path></svg>
</button>
<button id="layout-edit-btn" class="absolute bottom-2 left-2 w-8 h-8 rounded-full bg-blue-600 border border-white/30 flex items-center justify-center cursor-pointer transition-colors hover:bg-blue-500 z-50" title="Toggle Layout Edit Mode">
<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
</button>
<div id="main-tabs-container" class="flex-shrink-0 flex items-center overflow-x-auto whitespace-nowrap custom-scrollbar-x border-b" style="border-color: var(--border-color-main);">
<button class="main-tab-button active tappable-tab" data-tab="equipment" data-tab-order="1">Equipment</button>
<button class="main-tab-button tappable-tab" data-tab="inventory" data-tab-order="2">Inventory</button>
<button class="main-tab-button tappable-tab" data-tab="stats" data-tab-order="3">Stats</button>
<button class="main-tab-button tappable-tab" data-tab="combat" data-tab-order="4">Combat</button>
<button class="main-tab-button tappable-tab" data-tab="settings" data-tab-order="5">Settings</button>
</div>
<div id="main-tab-content" class="flex-grow p-2 md:p-4 overflow-y-auto custom-scrollbar relative">
<div id="tab-content-equipment" class="main-tab-panel active"></div>
<div id="tab-content-inventory" class="main-tab-panel"></div>
<div id="tab-content-stats" class="main-tab-panel"></div>
<div id="tab-content-combat" class="main-tab-panel"></div>
<div id="tab-content-settings" class="main-tab-panel"></div>
</div>
</main>
</section>
</div>
<div id="footer-container" class="tappable-section" data-order="3">
<footer id="footer-section" class="flex-shrink-0 flex items-stretch gap-2 controls-hidden">
<section id="communication-panel" class="flex-grow">
<div id="footer-chat-container" class="h-full glass-panel w-full p-2 rounded-lg flex flex-col">
<div class="flex-shrink-0 flex flex-wrap gap-1 mb-2">
<button data-channel="main" class="footer-tab-button glass-button text-xs px-3 py-1 rounded-md flex-grow active">Main</button>
<button data-channel="sales" class="footer-tab-button glass-button text-xs px-3 py-1 rounded-md flex-grow">Sales</button>
<button data-channel="clan" class="footer-tab-button glass-button text-xs px-3 py-1 rounded-md flex-grow">Clan</button>
<button id="open-chat-modal-btn" class="glass-button text-xs px-2 py-1 rounded-md" title="Open Full Chat">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5"></path></svg>
</button>
</div>
<div id="footer-chat-content-wrapper" class="text-xs space-y-1 overflow-y-auto custom-scrollbar" style="height: 70px;"></div>
<form id="footer-message-form" class="flex-shrink-0 flex gap-2 mt-2">
<input type="text" id="footer-message-input" class="footer-chat-input flex-grow w-full px-2 py-1 text-xs rounded-md" placeholder="Type a message..." autocomplete="off">
<button type="submit" id="footer-send-button" class="glass-button text-xs px-3 py-1 rounded-md">Send</button>
</form>
</div>
</section>
<section id="controls-panel" class="h-full glass-panel p-2 rounded-lg">
<div class="flex flex-col items-center justify-center h-full">
<div id="d-pad-controls" class="d-pad-controls">
<div class="game-key move-key" id="key-up" data-key="up"><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
<div class="game-key move-key" id="key-left" data-key="left"><svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"></path></svg></div>
<div class="game-key move-key" id="key-down" data-key="down"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg></div>
<div class="game-key move-key" id="key-right" data-key="right"><svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"></path></svg></div>
</div>
<div class="game-key" id="key-interact" data-key="interact">Interact</div>
</div>
</section>
</footer>
</div>
</div>
</div>
<div id="modal-container"></div>
<div id="toast-notification"></div>
<div id="chat-modal" class="modal-backdrop hidden">
<div class="relative w-11/12 max-w-5xl h-[90vh] max-h-[850px] rounded-2xl flex glass-panel overflow-hidden">
<button id="close-chat-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white z-50">
<svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
</button>
<div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden md:hidden"></div>
<div id="sidebar" class="absolute md:relative z-40 h-full w-4/5 max-w-xs md:w-1/3 md:max-w-[320px] flex flex-col p-4 transition-transform duration-300 ease-in-out sidebar-closed md:sidebar-open glass-panel md:bg-transparent md:border-r md:border-l-0 md:border-t-0 md:border-b-0 md:shadow-none" style="border-color: rgba(255,255,255,0.1);">
<button id="close-sidebar-btn" class="md:hidden absolute top-4 right-4 text-gray-300 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
<div class="mt-8 md:mt-0 p-3 glass-panel rounded-lg">
<div class="flex items-center gap-3">
<img id="sidebar-avatar" src="https://placehold.co/64x64/1e232d/22d3ee?text=J" class="avatar w-12 h-12">
<div class="text-left overflow-hidden">
<p id="sidebar-username" class="font-bold text-lg truncate font-orbitron">JuugBoyTV</p>
<p class="text-xs capitalize" style="opacity: 0.8;">Player</p>
</div>
</div>
</div>
<div class="flex-grow flex flex-col min-h-0 pt-4">
<h2 id="online-users-header" class="text-lg font-orbitron mb-2 pl-2">Online</h2>
<div id="online-users-list" class="flex-grow overflow-y-auto custom-scrollbar pr-2"></div>
</div>
</div>
<div class="flex-1 flex flex-col w-full md:w-auto min-w-0">
<div class="p-4 border-b flex items-center justify-between relative bg-black/20" style="border-color: rgba(255,255,255,0.1);">
<button id="open-sidebar-btn" class="md:hidden"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
<div id="tabs-container" class="flex-grow flex justify-center gap-4 md:gap-8 text-md font-orbitron font-bold">
<div class="tab active" data-channel="main">Main Chat</div>
<div class="tab" data-channel="sales">Sales Chat</div>
<div class="tab" data-channel="clan">Clan Chat</div>
</div>
<div class="w-7 md:hidden"></div>
</div>
<div id="content-container" class="flex-grow flex flex-col min-h-0 bg-black/10">
<div id="chat-messages" class="flex-grow p-4 overflow-y-auto custom-scrollbar"></div>
</div>
<div id="typing-indicator" class="px-4 pb-2 text-sm text-gray-500 h-6"></div>
<div id="reply-indicator" class="px-4 pt-2 hidden"><div class="glass-panel bg-opacity-80 rounded-t-lg p-2 text-sm"><div class="flex justify-between items-center"><div><p class="font-semibold" style="color: var(--highlight-color);">Replying to <span id="reply-username"></span></p><p id="reply-text" class="text-gray-300 truncate"></p></div><button id="cancel-reply-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button></div></div></div>
<form id="message-form" class="p-4 flex items-center gap-3 border-t bg-black/20" style="border-color: rgba(255,255,255,0.1);">
<input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" class="flex-grow">
<button type="submit" id="send-button" class="font-bold py-3 px-5 rounded-lg btn-primary">Send</button>
</form>
</div>
</div>
</div>
<div id="item-action-modal-backdrop" style="display: none;"></div>
<div id="item-action-modal-content" class="glass-panel p-4 rounded-lg" style="display: none;">
<div id="item-action-modal-body" class="item-action-modal-body"></div>
</div>
<div id="stat-info-modal" style="display: none;">
<div id="stat-info-backdrop"></div>
<div class="stat-info-content glass-panel">
<h4 id="stat-info-title" class="font-orbitron text-lg text-white mb-2"></h4>
<p id="stat-info-description" class="text-gray-300"></p>
</div>
</div>
<div id="info-modal-backdrop" class="modal-backdrop" style="display: none;">
<div id="info-modal-content" class="modal-content glass-panel p-6 rounded-lg"></div>
</div>
<div id="gem-tooltip-backdrop" class="modal-backdrop" style="display: none;">
<div id="gem-tooltip-content" class="modal-content glass-panel p-4 rounded-lg"></div>
</div>
<div id="socket-confirm-backdrop" class="modal-backdrop" style="display: none;">
<div id="socket-confirm-content" class="modal-content glass-panel p-4 rounded-lg"></div>
</div>
<div id="unsocket-choice-modal-backdrop" class="modal-backdrop" style="display: none;">
<div id="unsocket-choice-modal-content" class="modal-content glass-panel p-4 rounded-lg"></div>
</div>
<div id="full-screen-map-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex-col items-center justify-between p-4">
<h3 id="world-map-title" class="font-orbitron text-2xl text-glow-label mt-4">World Map</h3>
<div class="w-full flex-grow flex items-center justify-center my-4">
<div id="zone-canvas-container" class="w-full h-full max-w-4xl max-h-4xl aspect-square bg-black/30 rounded-lg border-2 border-[var(--border-color-main)] relative">
    <canvas id="zone-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
</div>
</div>
<div class="flex flex-col items-center">
<div class="d-pad-controls" id="map-d-pad">
<div class="game-key move-key key-up" data-key="up"><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
<div class="game-key move-key key-left" data-key="left"><svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"></path></svg></div>
<div class="game-key move-key key-down" data-key="down"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg></div>
<div class="game-key move-key" id="key-right" data-key="right"><svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"></path></svg></div>
</div>
<div class="game-key key-interact" data-key="interact">Interact</div>
</div>
<button id="map-close-btn" class="absolute top-4 right-4 text-3xl text-gray-400 hover:text-white">&times;</button>
</div>
<script type="module">
// --- GDD DATA MODULES (COPIED IN-LINE) ---
// This is done to ensure the file is self-contained.
const formulas = {
  "derivedStats": {
    "MaximumHP": {
      "formula": "100 + (VIT * 10)",
      "description": "Calculates Maximum HP based on Vitality."
    },
    "ArmorClass": {
      "formula": "(Sum of AC from Gear) * (1 + (VIT * 0.0075))",
      "description": "Calculates Armor Class based on gear and Vitality."
    },
    "WeaponClass": {
      "True Fighter": {
        "formula": "(Sum of WC from Gear) * (1 + (DEX * 0.0055))",
        "scalingStat": "DEX"
      },
      "Martial Hybrid": {
        "formula": "(Sum of WC from Gear) * (1 + (DEX * 0.0055))",
        "scalingStat": "DEX"
      },
      "Mystic Hybrid": {
        "formula": "(Sum of WC from Gear) * (1 + (WIS * 0.0055))",
        "scalingStat": "WIS"
      },
      "Troll": {
        "formula": "(Sum of WC from Gear) * (1 + (VIT * 0.0055))",
        "scalingStat": "VIT",
        "specialCase": true
      }
    },
    "SpellClass": {
      "True Caster": {
        "formula": "(Sum of SC from Gear) * (1 + (WIS * 0.0055))",
        "scalingStat": "WIS"
      },
      "Martial Hybrid": {
        "formula": "(Sum of SC from Gear) * (1 + (DEX * 0.0055))",
        "scalingStat": "DEX"
      },
      "Mystic Hybrid": {
        "formula": "(Sum of SC from Gear) * (1 + (WIS * 0.0055))",
        "scalingStat": "WIS"
      },
      "Vampire": {
        "formula": "(Sum of SC from Gear) * (1 + (VIT * 0.0055))",
        "scalingStat": "VIT",
        "specialCase": true
      }
    },
    "HitChance": {
      "DEX_Based": {
        "formula": "90 + (DEX * 0.05)",
        "archetypes": ["True Fighter", "Martial Hybrid"]
      },
      "WIS_Based": {
        "formula": "90 + (WIS * 0.05)",
        "archetypes": ["True Caster", "Mystic Hybrid"]
      }
    },
    "CriticalHitChance": {
      "DEX_Based": {
        "formula": "5 + (DEX * 0.01)",
        "archetypes": ["True Fighter", "Martial Hybrid"]
      },
      "WIS_Based": {
        "formula": "5 + (WIS * 0.01)",
        "archetypes": ["True Caster", "Mystic Hybrid"]
      }
    },
    "RacialPower": {
      "SingleStat": {
        "formula": "PrimaryStat * 0.10"
      },
      "DualStat": {
        "formula": "(Stat1 * 0.05) + (Stat2 * 0.05)"
      }
    }
  },
  "combat": {
    "PlayerDamage": {
      "formula": "(90 * Player_WC_or_SC) / Monster_AC",
      "description": "Player damage is reduced by monster AC via division."
    },
    "MonsterDamage": {
      "formula": "Monster_Attack - (Player_AC * 0.5)",
      "description": "Monster damage is reduced by player AC via subtraction."
    },
    "SpellstrikeDamage": {
      "formula": "((90 * Player_WC) / Monster_AC + (90 * Player_SC) / Monster_AC) * 0.8",
      "description": "Hybrid damage from WC and SC, balanced by a 0.8x modifier."
    }
  },
  "progression": {
    "ExperienceToLevel": {
      "formula": "200 * (1.12 ^ Current_Level)",
      "description": "Exponential XP curve to create the 'Grind Wall'."
    },
    "MasteryXPToPoint": {
      "formula": "5000 * (1.15 ^ Current_Mastery_Points)",
      "description": "Steep exponential curve for Mastery Point acquisition."
    }
  },
  "healthAndResources": {
    "BaseHealthRegen": {
      "formula": "floor(5 + (PlayerLevel * 1.5))",
      "description": "Static, level-based HP regeneration per turn."
    },
    "GearHealthRegen": {
      "formula": "CurrentMaxHP * sum(%Regen FromAllSources)",
      "description": "Percentage-based HP regeneration from gear and effects."
    },
    "TotalHealthRegen": {
      "formula": "BaseRegen + floor(GearRegen)",
      "inCombatModifier": 0.5,
      "description": "Total HP regen per turn, reduced by 50% while in combat."
    }
  }
};
const races = {
  "human": { "raceName": "Human", "archetype": "True Fighter", "subArchetype": null, "specialistTitle": "Blademaster", "coreCombatIdentity": "The Versatile Duelist", "primaryStat": "DEX", "apAllocationWeights": { "STR": 15, "DEX": 20, "VIT": 10, "NTL": 5, "WIS": 5 }, "masteryAptitudes": { "Sword": 1, "Axe": null, "Mace": null, "Staff": null, "Dagger": null, "Claw": null, "Bow": null, "Armor": 2, "Dbl Hit": 3 } },
  "dragonborn": { "raceName": "Dragonborn", "archetype": "True Fighter", "subArchetype": null, "specialistTitle": "Blademaster", "coreCombatIdentity": "The Powerhouse Knight", "primaryStat": "DEX", "apAllocationWeights": { "STR": 18, "DEX": 20, "VIT": 12, "NTL": 2, "WIS": 3 }, "masteryAptitudes": { "Sword": 1, "Axe": null, "Mace": null, "Staff": null, "Dagger": null, "Claw": null, "Bow": null, "Armor": 2, "Dbl Hit": 3 } },
  "orc": { "raceName": "Orc", "archetype": "True Fighter", "subArchetype": null, "specialistTitle": "Mauler", "coreCombatIdentity": "The Definitive Mace Wielder", "primaryStat": "DEX", "apAllocationWeights": { "STR": 20, "DEX": 18, "VIT": 15, "NTL": 2, "WIS": 2 }, "masteryAptitudes": { "Sword": null, "Axe": null, "Mace": 1, "Staff": null, "Dagger": null, "Claw": null, "Bow": null, "Armor": 2, "Dbl Hit": 3 } },
  "werewolf": { "raceName": "Werewolf", "archetype": "True Fighter", "subArchetype": null, "specialistTitle": "Ravager", "coreCombatIdentity": "The Definitive Claw Wielder", "primaryStat": "DEX", "apAllocationWeights": { "STR": 15, "DEX": 22, "VIT": 13, "NTL": 2, "WIS": 3 }, "masteryAptitudes": { "Sword": null, "Axe": null, "Mace": null, "Staff": null, "Dagger": null, "Claw": 1, "Bow": null, "Armor": 2, "Dbl Hit": 3 } },
  "minotaur": { "raceName": "Minotaur", "archetype": "True Fighter", "subArchetype": null, "specialistTitle": "Executioner", "coreCombatIdentity": "The Definitive Axe Wielder", "primaryStat": "DEX", "apAllocationWeights": { "STR": 22, "DEX": 18, "VIT": 14, "NTL": 2, "WIS": 2 }, "masteryAptitudes": { "Sword": null, "Axe": 1, "Mace": null, "Staff": null, "Dagger": null, "Claw": null, "Bow": null, "Armor": 2, "Dbl Hit": 3 } },
  "troll": { "raceName": "Troll", "archetype": "True Fighter", "subArchetype": null, "specialistTitle": "Juggernaut", "coreCombatIdentity": "The Definitive Staff Wielder", "primaryStat": "VIT", "specialCase": "Damage scales with VIT instead of DEX.", "apAllocationWeights": { "STR": 10, "DEX": 5, "VIT": 25, "NTL": 5, "WIS": 5 }, "masteryAptitudes": { "Sword": null, "Axe": null, "Mace": null, "Staff": 1, "Dagger": null, "Claw": null, "Bow": null, "Armor": 2, "Dbl Hit": 3 } },
  "hobbit": { "raceName": "Hobbit", "archetype": "True Fighter", "subArchetype": null, "specialistTitle": "Cutthroat", "coreCombatIdentity": "The Definitive Dagger Wielder", "primaryStat": "DEX", "apAllocationWeights": { "STR": 8, "DEX": 25, "VIT": 12, "NTL": 3, "WIS": 7 }, "masteryAptitudes": { "Sword": null, "Axe": null, "Mace": null, "Staff": null, "Dagger": 1, "Claw": null, "Bow": null, "Armor": 2, "Dbl Hit": 3 } },
  "centaur": { "raceName": "Centaur", "archetype": "True Fighter", "subArchetype": null, "specialistTitle": "Sharpshooter", "coreCombatIdentity": "The Definitive Ranged Wielder", "primaryStat": "DEX", "apAllocationWeights": { "STR": 12, "DEX": 24, "VIT": 10, "NTL": 3, "WIS": 6 }, "masteryAptitudes": { "Sword": null, "Axe": null, "Mace": null, "Staff": null, "Dagger": null, "Claw": null, "Bow": 1, "Armor": 2, "Dbl Hit": 3 } },
  "phoenix": { "raceName": "Phoenix", "archetype": "True Caster", "subArchetype": null, "specialistTitle": "Pyromancer", "coreCombatIdentity": "The Explosive Pyromancer", "primaryStat": "WIS", "apAllocationWeights": { "STR": 2, "DEX": 3, "VIT": 10, "NTL": 20, "WIS": 20 }, "masteryAptitudes": { "Fire": 1, "Cold": null, "Earth": null, "Air": null, "Arcane": null, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "tiefling": { "raceName": "Tiefling", "archetype": "True Caster", "subArchetype": null, "specialistTitle": "Pyromancer", "coreCombatIdentity": "The Infernal Sorcerer", "primaryStat": "WIS", "apAllocationWeights": { "STR": 3, "DEX": 5, "VIT": 8, "NTL": 20, "WIS": 19 }, "masteryAptitudes": { "Fire": 1, "Cold": null, "Earth": null, "Air": null, "Arcane": null, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "mermaid": { "raceName": "Mermaid", "archetype": "True Caster", "subArchetype": null, "specialistTitle": "Cryomancer", "coreCombatIdentity": "The Definitive Cold Caster", "primaryStat": "WIS", "apAllocationWeights": { "STR": 2, "DEX": 4, "VIT": 12, "NTL": 19, "WIS": 18 }, "masteryAptitudes": { "Fire": null, "Cold": 1, "Earth": null, "Air": null, "Arcane": null, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "gnome": { "raceName": "Gnome", "archetype": "True Caster", "subArchetype": null, "specialistTitle": "Geomancer", "coreCombatIdentity": "The Definitive Earth Caster", "primaryStat": "WIS", "apAllocationWeights": { "STR": 4, "DEX": 2, "VIT": 14, "NTL": 20, "WIS": 15 }, "masteryAptitudes": { "Fire": null, "Cold": null, "Earth": 1, "Air": null, "Arcane": null, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "griffin": { "raceName": "Griffin", "archetype": "True Caster", "subArchetype": null, "specialistTitle": "Aeromancer", "coreCombatIdentity": "The Definitive Air Caster", "primaryStat": "WIS", "apAllocationWeights": { "STR": 2, "DEX": 8, "VIT": 8, "NTL": 17, "WIS": 20 }, "masteryAptitudes": { "Fire": null, "Cold": null, "Earth": null, "Air": 1, "Arcane": null, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "vampire": { "raceName": "Vampire", "archetype": "True Caster", "subArchetype": null, "specialistTitle": "Sanguinist", "coreCombatIdentity": "The Definitive Drain Caster", "primaryStat": "VIT", "specialCase": "Damage scales with VIT instead of WIS.", "apAllocationWeights": { "STR": 5, "DEX": 5, "VIT": 25, "NTL": 10, "WIS": 5 }, "masteryAptitudes": { "Fire": null, "Cold": null, "Earth": null, "Air": null, "Arcane": null, "Death": null, "Drain": 1, "Armor": 3, "Dbl Hit": 3 } },
  "elf": { "raceName": "Elf", "archetype": "True Caster", "subArchetype": null, "specialistTitle": "Arcanist", "coreCombatIdentity": "The Definitive Arcane Caster", "primaryStat": "WIS", "apAllocationWeights": { "STR": 2, "DEX": 7, "VIT": 7, "NTL": 20, "WIS": 19 }, "masteryAptitudes": { "Fire": null, "Cold": null, "Earth": null, "Air": null, "Arcane": 1, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "babaYaga": { "raceName": "Baba Yaga", "archetype": "True Caster", "subArchetype": null, "specialistTitle": "Necromancer", "coreCombatIdentity": "The Definitive Death Caster", "primaryStat": "WIS", "apAllocationWeights": { "STR": 3, "DEX": 2, "VIT": 10, "NTL": 19, "WIS": 21 }, "masteryAptitudes": { "Fire": null, "Cold": null, "Earth": null, "Air": null, "Arcane": null, "Death": 1, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "angel": { "raceName": "Angel", "archetype": "Hybrid", "subArchetype": "Martial Hybrid", "primaryStat": "DEX", "apAllocationWeights": { "STR": 12, "DEX": 18, "VIT": 8, "NTL": 8, "WIS": 9 }, "masteryAptitudes": { "Sword": 2, "Axe": null, "Mace": null, "Staff": null, "Dagger": null, "Claw": null, "Bow": null, "Fire": null, "Cold": null, "Earth": null, "Air": null, "Arcane": 2, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "aasimar": { "raceName": "Aasimar", "archetype": "Hybrid", "subArchetype": "Martial Hybrid", "primaryStat": "DEX", "apAllocationWeights": { "STR": 14, "DEX": 18, "VIT": 9, "NTL": 7, "WIS": 7 }, "masteryAptitudes": { "Sword": null, "Axe": null, "Mace": 2, "Staff": null, "Dagger": null, "Claw": null, "Bow": null, "Fire": null, "Cold": null, "Earth": null, "Air": null, "Arcane": 2, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "banshee": { "raceName": "Banshee", "archetype": "Hybrid", "subArchetype": "Martial Hybrid", "primaryStat": "DEX", "apAllocationWeights": { "STR": 6, "DEX": 20, "VIT": 7, "NTL": 9, "WIS": 13 }, "masteryAptitudes": { "Sword": null, "Axe": null, "Mace": null, "Staff": null, "Dagger": 2, "Claw": null, "Bow": null, "Fire": null, "Cold": null, "Earth": null, "Air": null, "Arcane": 2, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "halfling": { "raceName": "Halfling", "archetype": "Hybrid", "subArchetype": "Martial Hybrid", "primaryStat": "DEX", "apAllocationWeights": { "STR": 7, "DEX": 21, "VIT": 10, "NTL": 7, "WIS": 10 }, "masteryAptitudes": { "Sword": null, "Axe": null, "Mace": null, "Staff": 2, "Dagger": null, "Claw": null, "Bow": null, "Fire": null, "Cold": null, "Earth": null, "Air": null, "Arcane": 2, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": "B" } },
  "dwarf": { "raceName": "Dwarf", "archetype": "Hybrid", "subArchetype": "Mystic Hybrid", "primaryStat": "WIS", "apAllocationWeights": { "STR": 12, "DEX": 8, "VIT": 10, "NTL": 12, "WIS": 18 }, "masteryAptitudes": { "Sword": null, "Axe": 2, "Mace": null, "Staff": null, "Dagger": null, "Claw": null, "Bow": null, "Fire": 2, "Cold": null, "Earth": null, "Air": null, "Arcane": null, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": "B" } },
  "demon": { "raceName": "Demon", "archetype": "Hybrid", "subArchetype": "Mystic Hybrid", "primaryStat": "WIS", "apAllocationWeights": { "STR": 10, "DEX": 8, "VIT": 8, "NTL": 15, "WIS": 19 }, "masteryAptitudes": { "Sword": null, "Axe": null, "Mace": null, "Staff": 2, "Dagger": null, "Claw": null, "Bow": null, "Fire": 2, "Cold": null, "Earth": null, "Air": null, "Arcane": null, "Death": null, "Drain": null, "Armor": 3, "Dbl Hit": "B" } },
  "draugr": { "raceName": "Draugr", "archetype": "Hybrid", "subArchetype": "Mystic Hybrid", "primaryStat": "WIS", "apAllocationWeights": { "STR": 13, "DEX": 6, "VIT": 12, "NTL": 12, "WIS": 17 }, "masteryAptitudes": { "Sword": null, "Axe": null, "Mace": null, "Staff": 2, "Dagger": null, "Claw": null, "Bow": null, "Fire": null, "Cold": null, "Earth": null, "Air": null, "Arcane": null, "Death": 2, "Drain": null, "Armor": 3, "Dbl Hit": 3 } },
  "unicorn": { "raceName": "Unicorn", "archetype": "Hybrid", "subArchetype": "Mystic Hybrid", "primaryStat": "WIS", "apAllocationWeights": { "STR": 8, "DEX": 10, "VIT": 9, "NTL": 13, "WIS": 20 }, "masteryAptitudes": { "Sword": 2, "Axe": null, "Mace": null, "Staff": null, "Dagger": null, "Claw": null, "Bow": null, "Fire": null, "Cold": null, "Earth": null, "Air": null, "Arcane": null, "Death": 2, "Drain": null, "Armor": 3, "Dbl Hit": 3 } }
};
const progression = {
  "dropperTiers": [
    { "tier": 1, "minLevelReq": 1, "goldCostPerPiece": 50000, "classValue": 13.00, "attributeRequirements": { "STR": 5, "NTL": 5, "VIT": 5 } },
    { "tier": 2, "minLevelReq": 1, "goldCostPerPiece": 87500, "classValue": 15.86, "attributeRequirements": { "STR": 15, "NTL": 15, "VIT": 20 } },
    { "tier": 3, "minLevelReq": 100, "goldCostPerPiece": 153125, "classValue": 19.35, "attributeRequirements": { "STR": 25, "NTL": 25, "VIT": 35 } },
    { "tier": 4, "minLevelReq": 135, "goldCostPerPiece": 267968, "classValue": 23.61, "attributeRequirements": { "STR": 40, "NTL": 40, "VIT": 50 } },
    { "tier": 5, "minLevelReq": 184, "goldCostPerPiece": 468945, "classValue": 28.80, "attributeRequirements": { "STR": 55, "NTL": 55, "VIT": 70 } },
    { "tier": 6, "minLevelReq": 253, "goldCostPerPiece": 820654, "classValue": 35.14, "attributeRequirements": { "STR": 70, "NTL": 70, "VIT": 90 } },
    { "tier": 7, "minLevelReq": 386, "goldCostPerPiece": 1436145, "classValue": 42.87, "attributeRequirements": { "STR": 90, "NTL": 90, "VIT": 110 } },
    { "tier": 8, "minLevelReq": 1000, "goldCostPerPiece": 2513253, "classValue": 52.30, "attributeRequirements": { "STR": 110, "NTL": 110, "VIT": 135 } },
    { "tier": 9, "minLevelReq": 3571, "goldCostPerPiece": 4398193, "classValue": 63.81, "attributeRequirements": { "STR": 130, "NTL": 130, "VIT": 160 } },
    { "tier": 10, "minLevelReq": 6143, "goldCostPerPiece": 7696838, "classValue": 77.85, "attributeRequirements": { "STR": 155, "NTL": 155, "VIT": 190 } },
    { "tier": 11, "minLevelReq": 8714, "goldCostPerPiece": 13469467, "classValue": 94.97, "attributeRequirements": { "STR": 180, "NTL": 180, "VIT": 220 } },
    { "tier": 12, "minLevelReq": 17272, "goldCostPerPiece": 23571567, "classValue": 115.87, "attributeRequirements": { "STR": 205, "NTL": 205, "VIT": 250 } },
    { "tier": 13, "minLevelReq": 28180, "goldCostPerPiece": 41250242, "classValue": 141.36, "attributeRequirements": { "STR": 230, "NTL": 230, "VIT": 285 } },
    { "tier": 14, "minLevelReq": 39088, "goldCostPerPiece": 72187924, "classValue": 172.46, "attributeRequirements": { "STR": 260, "NTL": 260, "VIT": 320 } },
    { "tier": 15, "minLevelReq": 50000, "goldCostPerPiece": 126328867, "classValue": 210.40, "attributeRequirements": { "STR": 290, "NTL": 290, "VIT": 355 } },
    { "tier": 16, "minLevelReq": 83333, "goldCostPerPiece": 221075517, "classValue": 256.69, "attributeRequirements": { "STR": 320, "NTL": 320, "VIT": 395 } },
    { "tier": 17, "minLevelReq": 127777, "goldCostPerPiece": 386882155, "classValue": 313.16, "attributeRequirements": { "STR": 350, "NTL": 350, "VIT": 435 } },
    { "tier": 18, "minLevelReq": 172222, "goldCostPerPiece": 677043771, "classValue": 382.06, "attributeRequirements": { "STR": 385, "NTL": 385, "VIT": 475 } },
    { "tier": 19, "minLevelReq": 216666, "goldCostPerPiece": 1184826599, "classValue": 466.11, "attributeRequirements": { "STR": 420, "NTL": 420, "VIT": 520 } },
    { "tier": 20, "minLevelReq": 400000, "goldCostPerPiece": 2073446549, "classValue": 568.65, "attributeRequirements": { "STR": 455, "NTL": 455, "VIT": 565 } }
  ],
  "dropperSlotModifiers": {
    "Weapon": { "statProportionality": 1.0, "statType": "WC" },
    "Spell": { "statProportionality": 1.0, "statType": "SC" },
    "Armor": { "statProportionality": 1.0, "statType": "AC" },
    "Helmet": { "statProportionality": 0.75, "statType": "AC" },
    "Boots": { "statProportionality": 0.75, "statType": "AC" },
    "Leggings": { "statProportionality": 0.50, "statType": "AC", "specialBonus": { "stat": "Hit Chance", "value": 0.10 } },
    "Gauntlets": { "statProportionality": 0.50, "statType": "AC", "specialBonus": { "stat": "WC/SC", "value": 0.15 } }
  },
  "gemGradeTiers": [
    { "gradeTier": 1, "unlockLevel": 1, "correspondingZone": "Z01-Z24" },
    { "gradeTier": 2, "unlockLevel": 100, "correspondingZone": "Z25" },
    { "gradeTier": 3, "unlockLevel": 253, "correspondingZone": "Z34" },
    { "gradeTier": 4, "unlockLevel": 1000, "correspondingZone": "Z51" },
    { "gradeTier": 5, "unlockLevel": 6143, "correspondingZone": "Z59" },
    { "gradeTier": 6, "unlockLevel": 13636, "correspondingZone": "Z66" },
    { "gradeTier": 7, "unlockLevel": 35452, "correspondingZone": "Z72" },
    { "gradeTier": 8, "unlockLevel": 83333, "correspondingZone": "Z79" },
    { "gradeTier": 9, "unlockLevel": 172222, "correspondingZone": "Z87" }
  ]
};
const gems = {
  "standard": {
    "loreStone": { "id": "loreStone", "name": "LoreStone", "category": "Caster", "color": "Blue", "effect": "Increase Base Spell Class", "grades": [1.5, 2.5, 3.5, 5, 7, 9, 11, 13, 15] },
    "mindrite": { "id": "mindrite", "name": "Mindrite", "category": "Caster", "color": "Blue", "effect": "Increase Wisdom", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] },
    "dullrite": { "id": "dullrite", "name": "Dullrite", "category": "Caster", "color": "Blue", "effect": "Decrease Enemy Wisdom", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] },
    "drainrite": { "id": "drainrite", "name": "Drainrite", "category": "Caster", "color": "Blue", "effect": "Steal Enemy Wisdom", "grades": [4, 6, 9, 15, 25, 40, 50, 60, 75] },
    "mindStone": { "id": "mindStone", "name": "MindStone", "category": "Caster", "color": "Blue", "effect": "Increase Intelligence", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] },
    "dullStone": { "id": "dullStone", "name": "DullStone", "category": "Caster", "color": "Blue", "effect": "Decrease Enemy Intelligence", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] },
    "drawStone": { "id": "drawStone", "name": "DrawStone", "category": "Caster", "color": "Blue", "effect": "Steal Enemy Intelligence", "grades": [4, 6, 9, 15, 25, 40, 50, 60, 75] },
    "warStone": { "id": "warStone", "name": "WarStone", "category": "Fighter", "color": "Red", "effect": "Increase Base Weapon Class", "grades": [1.5, 2.5, 3.5, 5, 7, 9, 11, 13, 15] },
    "mightrite": { "id": "mightrite", "name": "Mightrite", "category": "Fighter", "color": "Red", "effect": "Increase Dexterity", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] },
    "cripplite": { "id": "cripplite", "name": "Cripplite", "category": "Fighter", "color": "Red", "effect": "Decrease Enemy Dexterity", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] },
    "siphilite": { "id": "siphilite", "name": "Siphilite", "category": "Fighter", "color": "Red", "effect": "Steal Enemy Dexterity", "grades": [4, 6, 9, 15, 25, 40, 50, 60, 75] },
    "mightStone": { "id": "mightStone", "name": "MightStone", "category": "Fighter", "color": "Red", "effect": "Increase Strength", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] },
    "weakStone": { "id": "weakStone", "name": "WeakStone", "category": "Fighter", "color": "Red", "effect": "Decrease Enemy Strength", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] },
    "sapStone": { "id": "sapStone", "name": "SapStone", "category": "Fighter", "color": "Red", "effect": "Steal Enemy Strength", "grades": [4, 6, 9, 15, 25, 40, 50, 60, 75] },
    "obsidianHeart": { "id": "obsidianHeart", "name": "Obsidian Heart", "category": "Misc", "color": "Green", "effect": "Increase Base Armor Class", "grades": [1.5, 2.5, 3.5, 5, 7, 9, 11, 13, 15] },
    "spikeCore": { "id": "spikeCore", "name": "Spike-Core", "category": "Misc", "color": "Yellow", "effect": "Increase Critical Hit Chance", "grades": [1, 2.5, 5, 7.5, 10, 12.5, 15, 17.5, 20] },
    "trueCore": { "id": "trueCore", "name": "True-Core", "category": "Misc", "color": "Green", "effect": "Increase Hit Chance", "grades": [3, 6, 9, 12, 15, 18, 21, 25, 30] },
    "veilCore": { "id": "veilCore", "name": "Veil-Core", "category": "Misc", "color": "Green", "effect": "Decrease Enemy Hit Chance", "grades": [2.7, 5.4, 8.1, 10.8, 13.5, 16.2, 18.9, 22.5, 27] },
    "vitalCore": { "id": "vitalCore", "name": "Vital-Core", "category": "Misc", "color": "Green", "effect": "Increase Vitality", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] },
    "bloodCore": { "id": "bloodCore", "name": "Blood-Core", "category": "Misc", "color": "Green", "effect": "Steal Enemy Health", "grades": [4, 6, 9, 15, 25, 40, 50, 60, 75] },
    "shadowCore": { "id": "shadowCore", "name": "Shadow-Core", "category": "Misc", "color": "Yellow", "effect": "Increase Shadow Drop Chance", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] },
    "treasureCore": { "id": "treasureCore", "name": "Treasure-Core", "category": "Misc", "color": "Yellow", "effect": "Increase Drop Chance", "grades": [2, 3, 4, 5, 6, 7, 8, 9, 10] },
    "ascendCore": { "id": "ascendCore", "name": "Ascend-Core", "category": "Misc", "color": "Yellow", "effect": "Increase Experience Gain", "grades": [2, 4, 6, 9, 12, 15, 19, 24, 30] },
    "midasCore": { "id": "midasCore", "name": "Midas-Core", "category": "Misc", "color": "Yellow", "effect": "Increase Gold Earned", "grades": [2, 4, 6, 9, 12, 15, 19, 24, 30] },
    "masterworkCore": { "id": "masterworkCore", "name": "Masterwork-Core", "category": "Misc", "color": "Yellow", "effect": "Increase Mastery Chance", "grades": [5, 10, 15, 20, 25, 30, 35, 40, 50] },
    "echoingCore": { "id": "echoingCore", "name": "Echoing-Core", "category": "Misc", "color": "Yellow", "effect": "Increase Double Hit Chance", "grades": [2, 3, 4, 5, 6, 7, 8, 10, 12] },
    "harvesterCore": { "id": "harvesterCore", "name": "Harvester-Core", "category": "Misc", "color": "Yellow", "effect": "Increase Resource Drop Chance", "grades": [5, 10, 15, 20, 30, 50, 55, 60, 75] }
  },
  "fusion": [
    { "id": "warHeart", "name": "WarHeart", "recipe": ["warStone", "obsidianHeart"], "effects": [ { "effect": "Inc. Base WC", "grades": [1.5, 2.5, 3.5, 5, 7, 9, 11, 13, 15] }, { "effect": "Inc. Base AC", "grades": [1.5, 2.5, 3.5, 5, 7, 9, 11, 13, 15] } ] },
    { "id": "loreHeart", "name": "LoreHeart", "recipe": ["loreStone", "obsidianHeart"], "effects": [ { "effect": "Inc. Base SC", "grades": [1.5, 2.5, 3.5, 5, 7, 9, 11, 13, 15] }, { "effect": "Inc. Base AC", "grades": [1.5, 2.5, 3.5, 5, 7, 9, 11, 13, 15] } ] },
    { "id": "trueRite", "name": "True-Rite", "recipe": ["trueCore", "dullrite"], "effects": [ { "effect": "Inc. Hit Chance", "grades": [3, 6, 9, 12, 15, 18, 21, 25, 30] }, { "effect": "Dec. Enemy WIS", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] } ] },
    { "id": "trueLite", "name": "True-Lite", "recipe": ["trueCore", "cripplite"], "effects": [ { "effect": "Inc. Hit Chance", "grades": [3, 6, 9, 12, 15, 18, 21, 25, 30] }, { "effect": "Dec. Enemy DEX", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] } ] },
    { "id": "shadowTreasure", "name": "Shadow Treasure", "recipe": ["shadowCore", "treasureCore"], "effects": [ { "effect": "Inc. Shadow Drop", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] }, { "effect": "Inc. Drop Chance", "grades": [2, 3, 4, 5, 6, 7, 8, 9, 10] } ] },
    { "id": "ascendTreasure", "name": "Ascend-Treasure", "recipe": ["ascendCore", "treasureCore"], "effects": [ { "effect": "Inc. EXP Gain", "grades": [2, 4, 6, 9, 12, 15, 19, 24, 30] }, { "effect": "Inc. Drop Chance", "grades": [2, 3, 4, 5, 6, 7, 8, 9, 10] } ] },
    { "id": "ascendMidas", "name": "Ascend-Midas", "recipe": ["ascendCore", "midasCore"], "effects": [ { "effect": "Inc. EXP Gain", "grades": [2, 4, 6, 9, 12, 15, 19, 24, 30] }, { "effect": "Inc. Gold Find", "grades": [2, 4, 6, 9, 12, 15, 19, 24, 30] } ] },
    { "id": "midasTreasure", "name": "Midas-Treasure", "recipe": ["midasCore", "treasureCore"], "effects": [ { "effect": "Inc. Gold Find", "grades": [2, 4, 6, 9, 12, 15, 19, 24, 30] }, { "effect": "Inc. Drop Chance", "grades": [2, 3, 4, 5, 6, 7, 8, 9, 10] } ] },
    { "id": "masteryEchoing", "name": "Mastery-Echoing", "recipe": ["masterworkCore", "echoingCore"], "effects": [ { "effect": "Inc. Mastery Chance", "grades": [5, 10, 15, 20, 25, 30, 35, 40, 50] }, { "effect": "Inc. Double Hit", "grades": [2, 3, 4, 5, 6, 7, 8, 10, 12] } ] },
    { "id": "sagerite", "name": "Sagerite", "recipe": ["mindStone", "mindrite"], "effects": [ { "effect": "Inc. INT", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] }, { "effect": "Inc. WIS", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] } ] },
    { "id": "drowseite", "name": "Drowseite", "recipe": ["dullrite", "dullStone"], "effects": [ { "effect": "Dec. Enemy WIS", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] }, { "effect": "Dec. Enemy INT", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] } ] },
    { "id": "leechrite", "name": "Leechrite", "recipe": ["drainrite", "drawStone"], "effects": [ { "effect": "Steal Enemy WIS", "grades": [4, 6, 9, 15, 25, 40, 50, 60, 75] }, { "effect": "Steal Enemy INT", "grades": [4, 6, 9, 15, 25, 40, 50, 60, 75] } ] },
    { "id": "vigorite", "name": "Vigorite", "recipe": ["mightStone", "mightrite"], "effects": [ { "effect": "Inc. STR", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] }, { "effect": "Inc. DEX", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] } ] },
    { "id": "debilitate", "name": "Debilitate", "recipe": ["cripplite", "weakStone"], "effects": [ { "effect": "Dec. Enemy DEX", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] }, { "effect": "Dec. Enemy STR", "grades": [8, 10, 12, 14, 16, 19, 22, 26, 30] } ] },
    { "id": "syphonite", "name": "Syphonite", "recipe": ["siphilite", "sapStone"], "effects": [ { "effect": "Steal Enemy DEX", "grades": [4, 6, 9, 15, 25, 40, 50, 60, 75] }, { "effect": "Steal Enemy STR", "grades": [4, 6, 9, 15, 25, 40, 50, 60, 75] } ] },
    { "id": "juggernautsEye", "name": "Juggernaut's Eye", "recipe": ["vitalCore", "warStone"], "effects": [ { "effect": "Inc. Vitality", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] }, { "effect": "Inc. Base WC", "grades": [1.5, 2.5, 3.5, 5, 7, 9, 11, 13, 15] } ] },
    { "id": "sanguineHeart", "name": "Sanguine-Heart", "recipe": ["vitalCore", "loreStone"], "effects": [ { "effect": "Inc. Vitality", "grades": [5, 7.5, 10, 12.5, 15, 20, 30, 40, 50] }, { "effect": "Inc. Base SC", "grades": [1.5, 2.5, 3.5, 5, 7, 9, 11, 13, 15] } ] }
  ],
  "primal": [
    { "id": "loreRite", "name": "LoreRite", "recipe": ["loreHeart", "trueRite"], "effects": [ { "effect": "Inc. Base SC" }, { "effect": "Inc. Base AC" }, { "effect": "Inc. Hit Chance" }, { "effect": "Dec. Enemy WIS" } ] },
    { "id": "warLite", "name": "WarLite", "recipe": ["warHeart", "trueLite"], "effects": [ { "effect": "Inc. Base WC" }, { "effect": "Inc. Base AC" }, { "effect": "Inc. Hit Chance" }, { "effect": "Dec. Enemy DEX" } ] },
    { "id": "shadowLore", "name": "ShadowLore", "recipe": ["loreStone", "shadowTreasure"], "effects": [ { "effect": "Inc. Base SC" }, { "effect": "Inc. Shadow Drop" }, { "effect": "Inc. Drop Chance" } ] },
    { "id": "shadowWar", "name": "ShadowWar", "recipe": ["warStone", "shadowTreasure"], "effects": [ { "effect": "Inc. Base WC" }, { "effect": "Inc. Shadow Drop" }, { "effect": "Inc. Drop Chance" } ] },
    { "id": "ascendLore", "name": "Ascend Lore", "recipe": ["loreStone", "ascendTreasure"], "effects": [ { "effect": "Inc. Base SC" }, { "effect": "Inc. EXP Gain" }, { "effect": "Inc. Drop Chance" } ] },
    { "id": "ascendWar", "name": "AscendWar", "recipe": ["warStone", "ascendTreasure"], "effects": [ { "effect": "Inc. Base WC" }, { "effect": "Inc. EXP Gain" }, { "effect": "Inc. Drop Chance" } ] },
    { "id": "loreMidas", "name": "LoreMidas", "recipe": ["loreHeart", "ascendMidas"], "effects": [ { "effect": "Inc. Base SC" }, { "effect": "Inc. Base AC" }, { "effect": "Inc. Gold Find" } ] },
    { "id": "warMidas", "name": "WarMidas", "recipe": ["warHeart", "ascendMidas"], "effects": [ { "effect": "Inc. Base WC" }, { "effect": "Inc. Base AC" }, { "effect": "Inc. Gold Find" } ] },
    { "id": "titansCore", "name": "Titan's Core", "recipe": ["juggernautsEye", "trueLite"], "effects": [ { "effect": "Inc. Vitality" }, { "effect": "Inc. Base WC" }, { "effect": "Inc. Hit Chance" }, { "effect": "Dec. Enemy DEX" } ] },
    { "id": "vampiricEssence", "name": "Vampiric Essence", "recipe": ["sanguineHeart", "leechrite"], "effects": [ { "effect": "Inc. Vitality" }, { "effect": "Inc. Base SC" }, { "effect": "Steal Enemy WIS" }, { "effect": "Steal Enemy INT" } ] }
  ]
};
const bestiary = {
  "Z01": { "zoneId": "Z01", "zoneName": "Crystal Caves", "minLevel": 1, "gearTier": 1, "monsters": [ { "id": "E01", "name": "StartZone Monster 1", "hp": 25, "atk": 10, "def": 13, "xp": 15, "gold": 3, "isBoss": false }, { "id": "E02", "name": "StartZone Monster 2", "hp": 28, "atk": 11, "def": 14, "xp": 16, "gold": 3, "isBoss": false }, { "id": "E03", "name": "StartZone Monster 3", "hp": 31, "atk": 12, "def": 15, "xp": 18, "gold": 4, "isBoss": false }, { "id": "E04", "name": "StartZone Monster 4", "hp": 34, "atk": 13, "def": 16, "xp": 20, "gold": 4, "isBoss": false }, { "id": "E05", "name": "StartZone Monster 5", "hp": 37, "atk": 14, "def": 17, "xp": 22, "gold": 5, "isBoss": false }, { "id": "E06", "name": "StartZone Monster 6", "hp": 41, "atk": 15, "def": 18, "xp": 25, "gold": 5, "isBoss": false }, { "id": "E07", "name": "StartZone Monster 7", "hp": 45, "atk": 16, "def": 20, "xp": 28, "gold": 6, "isBoss": false }, { "id": "E08", "name": "StartZone Monster 8", "hp": 49, "atk": 17, "def": 21, "xp": 31, "gold": 6, "isBoss": false }, { "id": "E09", "name": "StartZone Monster 9", "hp": 54, "atk": 18, "def": 23, "xp": 35, "gold": 7, "isBoss": false }, { "id": "E10", "name": "StartZone Monster 10", "hp": 59, "atk": 19, "def": 25, "xp": 39, "gold": 18, "isBoss": false }, { "id": "E10*", "name": "StartZone Boss", "hp": 60, "atk": 20, "def": 25, "xp": 100, "gold": 20, "isBoss": true } ] },
  "Z25": { "zoneId": "Z25", "zoneName": "Echoing Chasms", "minLevel": 100, "gearTier": 2, "monsters": [ { "id": "Z25-E01", "name": "Shrieker", "hp": 185, "atk": 93, "def": 123, "xp": 1500, "gold": 300, "isBoss": false }, { "id": "Z25-E02", "name": "Rocklurker", "hp": 204, "atk": 102, "def": 135, "xp": 1650, "gold": 330, "isBoss": false }, { "id": "Z25-E03", "name": "Deep Crawler", "hp": 224, "atk": 112, "def": 149, "xp": 1815, "gold": 363, "isBoss": false }, { "id": "Z25-E04", "name": "Echo Bat", "hp": 246, "atk": 123, "def": 164, "xp": 1997, "gold": 399, "isBoss": false }, { "id": "Z25-E05", "name": "Chasm Worm", "hp": 271, "atk": 135, "def": 180, "xp": 2196, "gold": 439, "isBoss": false }, { "id": "Z25-E06", "name": "Gloom Elemental", "hp": 298, "atk": 149, "def": 198, "xp": 2416, "gold": 483, "isBoss": false }, { "id": "Z25-E07", "name": "Pit Spider", "hp": 328, "atk": 164, "def": 218, "xp": 2657, "gold": 531, "isBoss": false }, { "id": "Z25-E08", "name": "Stone Sentinel", "hp": 361, "atk": 180, "def": 240, "xp": 2923, "gold": 585, "isBoss": false }, { "id": "Z25-E09", "name": "Whisper Wraith", "hp": 397, "atk": 198, "def": 264, "xp": 3215, "gold": 643, "isBoss": false }, { "id": "Z25-E10", "name": "Abyss Stalker", "hp": 433, "atk": 216, "def": 288, "xp": 3507, "gold": 701, "isBoss": false }, { "id": "Z25-E10*", "name": "Abyss Stalker - Boss", "hp": 437, "atk": 218, "def": 290, "xp": 10000, "gold": 2000, "isBoss": true } ] },
  "Z101": { "zoneId": "Z101", "zoneName": "The Echoing Gorge of Lost Souls", "minLevel": 400000, "gearTier": 20, "monsters": [ { "id": "Z101-E01", "name": "Soul Wraith", "hp": 1.85e+38, "atk": 9.25e+36, "def": 1.23e+37, "xp": 1.5e+50, "gold": 3e+48, "isBoss": false }, { "id": "Z101-E02", "name": "Echo Phantom", "hp": 2.04e+38, "atk": 1.02e+37, "def": 1.35e+37, "xp": 1.65e+50, "gold": 3.3e+48, "isBoss": false }, { "id": "Z101-E03", "name": "Lost Spirit", "hp": 2.24e+38, "atk": 1.12e+37, "def": 1.49e+37, "xp": 1.82e+50, "gold": 3.63e+48, "isBoss": false }, { "id": "Z101-E04", "name": "Sorrow Elemental", "hp": 2.46e+38, "atk": 1.23e+37, "def": 1.64e+37, "xp": 2e+50, "gold": 3.99e+48, "isBoss": false }, { "id": "Z101-E05", "name": "Canyon Shrieker", "hp": 2.71e+38, "atk": 1.35e+37, "def": 1.80e+37, "xp": 2.2e+50, "gold": 4.39e+48, "isBoss": false }, { "id": "Z101-E06", "name": "Abyss Whisperer", "hp": 2.98e+38, "atk": 1.49e+37, "def": 1.98e+37, "xp": 2.42e+50, "gold": 4.83e+48, "isBoss": false }, { "id": "Z101-E07", "name": "Despair Hound", "hp": 3.28e+38, "atk": 1.64e+37, "def": 2.18e+37, "xp": 2.66e+50, "gold": 5.31e+48, "isBoss": false }, { "id": "Z101-E08", "name": "Chasm Guardian", "hp": 3.61e+38, "atk": 1.80e+37, "def": 2.40e+37, "xp": 2.93e+50, "gold": 5.85e+48, "isBoss": false }, { "id": "Z101-E09", "name": "Tormented Soul", "hp": 3.97e+38, "atk": 1.98e+37, "def": 2.64e+37, "xp": 3.22e+50, "gold": 6.43e+48, "isBoss": false }, { "id": "Z101-E10", "name": "Echo of Regret", "hp": 4.33e+38, "atk": 2.16e+37, "def": 2.88e+37, "xp": 3.51e+50, "gold": 7.01e+48, "isBoss": false }, { "id": "Z101-E10*", "name": "Echo of Regret - Boss", "hp": 4.37e+38, "atk": 2.18e+37, "def": 2.90e+37, "xp": 1e+51, "gold": 2e+49, "isBoss": true } ] }
};
const items = {
  baseItemTemplates: [
    { id: 'base_helm_1', name: 'Helmet', type: 'Armor', subType: 'Helmet', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/refs/heads/juugboytv-equipment1/IMG_1396.png', sockets: 2},
    { id: 'base_armor_1', name: 'Armor', type: 'Armor', subType: 'Armor', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/refs/heads/juugboytv-equipment1/IMG_1401.png', sockets: 2},
    { id: 'base_gauntlets_1', name: 'Gauntlets', type: 'Armor', subType: 'Gauntlets', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/main/IMG_1402.png', sockets: 2},
    { id: 'base_leggings_1', name: 'Leggings', type: 'Armor', subType: 'Leggings', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/main/IMG_1403.png', sockets: 2},
    { id: 'base_boots_1', name: 'Boots', type: 'Armor', subType: 'Boots', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/main/IMG_1404.png', sockets: 2},
    { id: 'base_sword_1', name: 'Sword', type: 'Weapons', subType: 'Sword', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/Weapons/IMG_1412.png', sockets: 2 },
    { id: 'base_axe_1', name: 'Axe', type: 'Weapons', subType: 'Axe', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/Weapons/IMG_1413.png', sockets: 2 },
    { id: 'base_staff_1', name: 'Staff', type: 'Weapons', subType: 'Staff', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/Weapons/IMG_1416.png', sockets: 2 },
    { id: 'base_firespell_1', name: 'FireSpell', type: 'Spells', subType: 'Fire', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/refs/heads/Spells/IMG_1422.png', sockets: 2 },
    { id: 'base_airspell_1', name: 'AirSpell', type: 'Spells', subType: 'Air', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/Spells/IMG_1423.png', sockets: 2 },
    { id: 'base_deathspell_1', name: 'Death', type: 'Spells', subType: 'Death', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/Spells/IMG_1425.png', sockets: 2 },
    { id: 'base_accessory_1', name: 'Rune', type: 'Accessory', subType: 'Rune', imageUrl: 'https://placehold.co/60x60/1e232d/a855f7?text=RUNE', sockets: 2 },
    { id: 'base_amulet_1', name: 'Amulet', type: 'Amulet', subType: 'Amulet', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/refs/heads/Rings/IMG_1456.png', sockets: 2},
    { id: 'base_ring_1', name: 'Ring', type: 'Ring', subType: 'Ring', imageUrl: 'https://raw.githubusercontent.com/juugboytv/Geminus/refs/heads/Rings/IMG_1458.png', sockets: 2}
  ]
};
const gddConstants = {
    BASE_GEM_DROP_CHANCE: 1/250,
    BASE_SHADOW_DROP_CHANCE: 1/600,
    SHADOW_QM_MIN: 0.75,
    SHADOW_QM_MAX: 1.5,
    ECHO_QM: 0.5,
    XP_BASE: 200, XP_GROWTH_RATE: 1.12, AP_PER_LEVEL: 40,
    PLAYER_DAMAGE_CONSTANT: 90, HYBRID_SPELLSTRIKE_MULTIPLIER: 0.8,
    MONSTER_DAMAGE_AC_REDUCTION_FACTOR: 0.5,
    MONSTER_SCALING_HP_RATE: 1.20, MONSTER_SCALING_DEF_RATE: 1.20, MONSTER_SCALING_ATK_RATE: 1.22, MONSTER_SCALING_REWARD_RATE: 1.27
};
// [FIX] Added equipmentSlotConfig back for equipping logic
const equipmentSlotConfig = [
    { name: 'Helmet', type: 'Armor' }, { name: 'Weapon 1', type: 'Weapons' },
    { name: 'Armor', type: 'Armor' }, { name: 'Weapon 2', type: 'Weapons' },
    { name: 'Gauntlets', type: 'Armor' }, { name: 'Leggings', type: 'Armor' },
    { name: 'Boots', type: 'Armor' }, { name: 'Amulet', type: 'Amulet' },
    { name: 'Spell 1', type: 'Spells' }, { name: 'Ring', type: 'Ring' },
    { name: 'Spell 2', type: 'Spells' }, { name: 'Accessories', type: 'Accessory' }
];
// --- App State & Config ---
let state = {
player: null,
ui: {
isFocused: false,
isLayoutEditMode: false,
selectedInventoryId: null,
selectedGemId: null,
activeTab: 'socket',
activeSocketView: 'visual',
selectedGemForSocketing: null,
itemFilter: { category: 'All', subType: 'All', tier: 'All' },
gemFilter: { type: 'All', grade: 'All' }
},
game: { combatActive: false, currentZoneId: 'Z01', globalJackpot: 0},
zone: {
name: "No Zone Loaded",
},
keyState: { up: false, left: false, down: false, right: false, interact: false },
firebase: {
db: null,
auth: null,
userId: null,
playerDocRef: null,
},
chat: {
currentChannel: 'main',
unsubscribeListener: null,
}
};
// --- Zone Data ---
// As requested, placeholder map data has been removed to create a clean slate.
// The game will now require a map to be imported via the Settings tab to begin.
const embeddedZoneData = null;

// --- Systems & Manager Functions ---
const Systems = {
  calculateDerivedStats(player) {
    player.derivedStats = {};
    const racialData = races[player.race]; // [FIX] This now works because player.race is the lowercase ID
    if (!racialData) throw new Error(`Invalid race specified: ${player.race}`);
    let totalGearAC = 0;
    let totalGearWC = 0;
    let totalGearSC = 0;
    let bonusHitChance = 0;
    let bonusWcScMultiplier = 1.0;
    for (const slotName in player.equipment) {
      const instanceId = player.equipment[slotName];
      if (!instanceId) continue;
      const item = player.inventory.find(i => i.instanceId === instanceId);
      const baseItem = items.baseItemTemplates.find(b => b.id === item.baseItemId);
      if (!item || !baseItem) continue;
      const slotData = progression.dropperSlotModifiers[baseItem.subType] || {};
      const tierData = progression.dropperTiers.find(t => t.tier === item.tier);
      if (!tierData) continue;
      const itemStatValue = tierData.classValue * (slotData.statProportionality || 0);
      if (slotData.statType === 'AC') totalGearAC += itemStatValue;
      if (slotData.statType === 'WC') totalGearWC += itemStatValue;
      if (slotData.statType === 'SC') totalGearSC += itemStatValue;
      if (slotData.specialBonus) {
        if (slotData.specialBonus.stat === 'Hit Chance') bonusHitChance += slotData.specialBonus.value;
        if (slotData.specialBonus.stat === 'WC/SC') bonusWcScMultiplier += slotData.specialBonus.value;
      }
    }
    let finalWC = 0, finalSC = 0;
    let scalingStatValue = 0;
    const primaryStat = racialData.primaryStat;
    scalingStatValue = player.baseStats[primaryStat] || 0;
    switch (racialData.archetype) {
      case 'True Fighter':
        if(racialData.specialCase === "Damage scales with VIT instead of DEX.") {
          finalWC = totalGearWC * (1 + ((player.baseStats.VIT || 0) * 0.0055));
        } else {
          finalWC = totalGearWC * (1 + (scalingStatValue * 0.0055));
        }
        break;
      case 'True Caster':
        if(racialData.specialCase === "Damage scales with VIT instead of WIS.") {
          finalSC = totalGearSC * (1 + ((player.baseStats.VIT || 0) * 0.0055));
        } else {
          finalSC = totalGearSC * (1 + (scalingStatValue * 0.0055));
        }
        break;
      case 'Hybrid':
        finalWC = totalGearWC * (1 + (scalingStatValue * 0.0055));
        finalSC = totalGearSC * (1 + (scalingStatValue * 0.0055));
        break;
    }
    finalWC *= bonusWcScMultiplier;
    finalSC *= bonusWcScMultiplier;
    player.derivedStats.maxHp = 100 + ((player.baseStats.VIT || 0) * 10);
    player.derivedStats.AC = totalGearAC * (1 + ((player.baseStats.VIT || 0) * 0.0075));
    player.derivedStats.WC = finalWC;
    player.derivedStats.SC = finalSC;
    if (primaryStat === 'DEX' || (racialData.archetype === 'True Fighter' && primaryStat === 'VIT')) {
      player.derivedStats.hitChance = 90 + ((player.baseStats.DEX || 0) * 0.05);
      player.derivedStats.critChance = 5 + ((player.baseStats.DEX || 0) * 0.01);
    } else {
      player.derivedStats.hitChance = 90 + ((player.baseStats.WIS || 0) * 0.05);
      player.derivedStats.critChance = 5 + ((player.baseStats.WIS || 0) * 0.01);
    }
    player.derivedStats.hitChance += (player.derivedStats.hitChance * bonusHitChance);
    if (player.hp === undefined || player.hp > player.derivedStats.maxHp) player.hp = player.derivedStats.maxHp;
    player.stats = player.derivedStats;
    return player;
  },
  MonsterScaling(monster, targetGearTier) {
    const baseMonster = { ...monster };
    if (targetGearTier <= 1) return baseMonster;
    const tierDiff = targetGearTier - 1;
    baseMonster.hp = baseMonster.hp * Math.pow(gddConstants.MONSTER_SCALING_HP_RATE, tierDiff);
    baseMonster.atk = baseMonster.atk * Math.pow(gddConstants.MONSTER_SCALING_ATK_RATE, tierDiff);
    baseMonster.def = baseMonster.def * Math.pow(gddConstants.MONSTER_SCALING_DEF_RATE, tierDiff);
    baseMonster.xp = baseMonster.xp * Math.pow(gddConstants.MONSTER_SCALING_REWARD_RATE, tierDiff);
    baseMonster.gold = baseMonster.gold * Math.pow(gddConstants.MONSTER_SCALING_REWARD_RATE, tierDiff);
    return baseMonster;
  },
  resolveCombatTurn(player, monster) {
    const racialData = races[player.race]; // [FIX] Removed .toLowerCase()
    if (!racialData) throw new Error(`Invalid race specified: ${player.race}`);
    let playerDamage = 0;
    const playerStats = player.derivedStats;
    const monsterStats = monster;
    const monsterAC = monsterStats.def;
    if (racialData.archetype === 'Hybrid') {
      const wcDamage = (gddConstants.PLAYER_DAMAGE_CONSTANT * playerStats.WC) / monsterAC;
      const scDamage = (gddConstants.PLAYER_DAMAGE_CONSTANT * playerStats.SC) / monsterAC;
      playerDamage = (wcDamage + scDamage) * gddConstants.HYBRID_SPELLSTRIKE_MULTIPLIER;
    } else if (racialData.archetype === 'True Fighter') {
      playerDamage = (gddConstants.PLAYER_DAMAGE_CONSTANT * playerStats.WC) / monsterAC;
    } else if (racialData.archetype === 'True Caster') {
      playerDamage = (gddConstants.PLAYER_DAMAGE_CONSTANT * playerStats.SC) / monsterAC;
    }
    monster.currentHP -= playerDamage;
    if (monster.currentHP <= 0) {
      monster.currentHP = 0;
      return { status: 'VICTORY', player, monster, damageDealt: playerDamage };
    }
    let monsterDamage = monsterStats.atk - (playerStats.AC * gddConstants.MONSTER_DAMAGE_AC_REDUCTION_FACTOR);
    monsterDamage = Math.max(0, monsterDamage);
    player.hp -= monsterDamage;
    if (player.hp <= 0) {
      player.hp = 0;
      return { status: 'DEFEAT', player, monster, damageTaken: monsterDamage };
    }
    return { status: 'CONTINUE', player, monster, damageDealt: playerDamage, damageTaken: monsterDamage };
  },
  simulateCombat(player, monster) {
    let simPlayer = JSON.parse(JSON.stringify(player));
    let simMonster = JSON.parse(JSON.stringify(monster));
    simMonster.currentHP = simMonster.hp;
    const combatLog = [`Combat Start: ${simPlayer.name} vs. ${simMonster.name}`];
    let turn = 1;
    let result = {};
    while (true) {
      result = Systems.resolveCombatTurn(simPlayer, simMonster);
      combatLog.push(`Turn ${turn}: ${simPlayer.name} deals ${result.damageDealt.toFixed(2)} damage. [Monster HP: ${simMonster.currentHP.toFixed(2)}]`);
      if (result.status === 'VICTORY') {
        combatLog.push(`${simMonster.name} has been defeated!`);
        break;
      }
      combatLog.push(`Turn ${turn}: ${simMonster.name} deals ${result.damageTaken.toFixed(2)} damage. [Player HP: ${simPlayer.hp.toFixed(2)}]`);
      if (result.status === 'DEFEAT') {
        combatLog.push(`${simPlayer.name} has been defeated!`);
        break;
      }
      turn++;
      if (turn > 100) {
        combatLog.push('Combat exceeded 100 turns. Halting simulation.');
        result.status = 'STALEMATE';
        break;
      }
    }
    return {
      outcome: result.status,
      finalState: { player: simPlayer, monster: simMonster },
      log: combatLog
    };
  },
  generateLoot(player, monster, currentZoneId) {
    const lootMessages = [];
    player.gold += monster.gold;
    player.xp += monster.xp;
    lootMessages.push(`You earned <span class="log-xp">${Math.floor(monster.xp)} XP</span> and <span class="log-gold">${Math.floor(monster.gold)} Gold</span>!`);
    if (Math.random() < gddConstants.BASE_GEM_DROP_CHANCE) {
        const zoneData = bestiary[currentZoneId];
        const gemGradeTier = progression.gemGradeTiers.find(g => g.correspondingZone.includes(zoneData.zoneId))?.gradeTier || 1;
        const allStandardGems = Object.values(gems.standard);
        const randomGem = allStandardGems[Math.floor(Math.random() * allStandardGems.length)];
        const newGem = { id: randomGem.id, grade: gemGradeTier };
        player.gems.push(newGem);
        lootMessages.push(`You found a new gem: <span class="log-loot-gem">${randomGem.name} (Grade ${newGem.grade})</span>!`);
    }
    if (Math.random() < gddConstants.BASE_SHADOW_DROP_CHANCE) {
        const equippedDroppers = Object.values(player.equipment).filter(itemId => {
            const item = player.inventory.find(i => i.instanceId === itemId);
            return item && item.type === 'Dropper';
        });
        if (equippedDroppers.length > 0) {
            const randomEquippedItemInstanceId = equippedDroppers[Math.floor(Math.random() * equippedDroppers.length)];
            const randomEquippedItem = player.inventory.find(i => i.instanceId === randomEquippedItemInstanceId);
            const existingShadow = Object.values(player.equipment).find(itemId => {
                const item = player.inventory.find(i => i.instanceId === itemId);
                return item && item.baseItemId === randomEquippedItem.baseItemId && item.type === 'Shadow';
            });
            let newItem;
            if (existingShadow) {
                newItem = { ...randomEquippedItem, instanceId: `${randomEquippedItem.baseItemId}_${Date.now()}_${Math.random()}`, type: 'Echo', qualityMultiplier: gddConstants.ECHO_QM, enchantments: [] };
                lootMessages.push(`A faint <span class="log-loot-item">Echo</span> of your ${items.baseItemTemplates.find(b => b.id === newItem.baseItemId).name} appears!`);
            } else {
                const randomQM = gddConstants.SHADOW_QM_MIN + (Math.random() * (gddConstants.SHADOW_QM_MAX - gddConstants.SHADOW_QM_MIN));
                newItem = { ...randomEquippedItem, instanceId: `${randomEquippedItem.baseItemId}_${Date.now()}_${Math.random()}`, type: 'Shadow', qualityMultiplier: randomQM, enchantments: [] };
                lootMessages.push(`The shadow of your <span class="log-loot-item">${items.baseItemTemplates.find(b => b.id === newItem.baseItemId).name}</span> solidifies! (QM: ${newItem.qualityMultiplier.toFixed(2)})`);
            }
            player.inventory.push(newItem);
        }
    }
    return lootMessages;
  }
};
// --- Utility Functions ---
function showToast(message, isError = false) {
ui.toastNotification.textContent = message;
ui.toastNotification.className = `glass-panel fixed left-1/2 -translate-x-1/2 z-[210] transition-all duration-500 ease-in-out px-6 py-3 rounded-lg font-semibold ${isError ? 'toast-error' : 'toast-success'}`;
ui.toastNotification.style.bottom = '5rem';
setTimeout(() => { ui.toastNotification.style.bottom = '-100px'; }, 3000);
}
// --- Smoke Canvas Animation ---
const smokeCanvas = document.getElementById('smoke-canvas');
const smokeCtx = smokeCanvas.getContext('2d');
smokeCanvas.width = window.innerWidth;
smokeCanvas.height = window.innerHeight;
let smokeParticles = [];
const smokeParticleCount = 75;
class SmokeParticle {
constructor(color) {
this.x = Math.random() * smokeCanvas.width;
this.y = Math.random() * smokeCanvas.height;
this.size = Math.random() * 150 + 50;
this.speedX = Math.random() * 0.4 - 0.2;
this.speedY = Math.random() * 0.4 - 0.2;
this.color = color;
}
update() {
this.x += this.speedX;
this.y += this.speedY;
if (this.x < -this.size) this.x = smokeCanvas.width + this.size;
if (this.x > smokeCanvas.width + this.size) this.x = -this.size;
if (this.y < -this.size) this.y = smokeCanvas.height + this.size;
if (this.y > smokeCanvas.height + this.size) this.y = -this.size;
}
draw() {
smokeCtx.fillStyle = this.color;
smokeCtx.beginPath();
smokeCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
smokeCtx.filter = 'blur(60px)';
smokeCtx.fill();
}
}
function initSmokeParticles(theme) {
smokeParticles = [];
const color = theme === 'molten-core'
? `rgba(249, 115, 22, ${Math.random() * 0.07})`
: `rgba(34, 211, 238, ${Math.random() * 0.07})`;
for (let i = 0; i < smokeParticleCount; i++) {
smokeParticles.push(new SmokeParticle(color));
}
}
function updateSmokeParticleColors(theme) {
const color = theme === 'molten-core'
? `rgba(249, 115, 22, ${Math.random() * 0.07})`
: `rgba(34, 211, 238, ${Math.random() * 0.07})`;
smokeParticles.forEach(p => {
p.color = color;
});
}
function animateSmoke() {
smokeCtx.clearRect(0, 0, smokeCanvas.width, smokeCanvas.height);
for (let i = 0; i < smokeParticles.length; i++) {
smokeParticles[i].update();
smokeParticles[i].draw();
}
requestAnimationFrame(animateSmoke);
}
window.addEventListener('resize', () => {
smokeCanvas.width = window.innerWidth;
smokeCanvas.height = window.innerHeight;
const currentTheme = localStorage.getItem('geminusTheme') || 'aetherial-shard';
initSmokeParticles(currentTheme);
if(WorldMapManager.isInitialized) {
WorldMapManager.isInitialized = false; // Force re-init to handle canvas resize
WorldMapManager.init();
}
if(ZoneManager.isInitialized) {
    ZoneManager.resizeCanvas();
    ZoneManager.draw();
}
});
animateSmoke();
// --- Data Manager (Firebase) ---
const DataManager = {
async init() {
try {
const firebaseConfig = {
apiKey: "AIzaSyA8wfcXLXVP2KanuhGPQeKnOeeGPDRKLzk",
authDomain: "gem-inus-on-ga-me.firebaseapp.com",
projectId: "gem-inus-on-ga-me",
storageBucket: "gem-inus-on-ga-me.appspot.com",
messagingSenderId: "663073930106",
appId: "1:663073930106:web:dbf2001917e856150134c3"
};
if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("YOUR_")) {
ModalManager.show("Configuration Needed", `<div class="text-center"><p class="mb-4">Welcome, Developer!</p><p>To enable saving, you need to add your Firebase configuration to the code.</p><p class="mt-2 text-sm text-gray-400">Please create a Firebase project and paste the config object into the designated area.</p></div>`);
return;
}
const appId = 'geminus-game';
const app = window.firebase.initializeApp(firebaseConfig);
state.firebase.db = window.firebase.getFirestore(app);
state.firebase.auth = window.firebase.getAuth(app);
await window.firebase.signInAnonymously(state.firebase.auth);
state.firebase.userId = state.firebase.auth.currentUser.uid;
if (!state.firebase.userId) throw new Error("Anonymous authentication failed.");
const userDocPath = `/artifacts/${appId}/users/${state.firebase.userId}`;
state.firebase.playerDocRef = window.firebase.doc(state.firebase.db, userDocPath);
console.log("Firebase initialized and user authenticated:", state.firebase.userId);
await this.loadPlayer();
} catch (error) {
console.error("Error initializing Firebase or loading data:", error);
showToast("Could not connect to the game server.", true);
CreationManager.init();
}
},
async loadPlayer() {
try {
const docSnap = await window.firebase.getDoc(state.firebase.playerDocRef);
if (docSnap.exists()) {
console.log("Player data found, loading character...");
state.player = docSnap.data();
if(typeof state.player.inventory === 'string') state.player.inventory = JSON.parse(state.player.inventory);
if(typeof state.player.equipment === 'string') state.player.equipment = JSON.parse(state.player.equipment);
if(typeof state.player.gems === 'string') state.player.gems = JSON.parse(state.player.gems);
GameManager.init();
} else {
console.log("No player data found, starting character creation.");
CreationManager.init();
}
} catch (error) {
console.error("Error loading player data:", error);
showToast("Failed to load your character.", true);
CreationManager.init();
}
},
async savePlayer(playerData) {
if (!state.firebase.playerDocRef) return console.error("Cannot save: Firebase is not initialized.");
try {
const dataToSave = {
...playerData,
inventory: JSON.stringify(playerData.inventory),
equipment: JSON.stringify(playerData.equipment),
gems: JSON.stringify(playerData.gems),
lastSaved: window.firebase.serverTimestamp()
};
await window.firebase.setDoc(state.firebase.playerDocRef, dataToSave);
console.log("Player data saved successfully.");
} catch (error) {
console.error("Error saving player data:", error);
showToast("Failed to save character progress.", true);
}
},
async updatePlayer(fieldsToUpdate) {
if (!state.firebase.playerDocRef) return console.error("Cannot update: Firebase is not initialized.");
try {
const updates = {...fieldsToUpdate};
for(const key in updates) {
if(typeof updates[key] === 'object' && updates[key] !== null) {
updates[key] = JSON.stringify(updates[key]);
}
}
updates.lastSaved = window.firebase.serverTimestamp();
await window.firebase.updateDoc(state.firebase.playerDocRef, updates);
} catch (error) {
if (error.code === 'not-found') await this.savePlayer(state.player);
else console.error("Error updating player data:", error);
}
}
};
// --- Chat Manager ---
const ChatManager = {
isInitialized: false,
init() {
if (this.isInitialized) return;
this.isInitialized = true;
this.addEventListeners();
this.switchChannel('main');
console.log("Chat Manager Initialized");
},
addEventListeners() {
ui.footerMessageForm.addEventListener('submit', (e) => {
e.preventDefault();
const input = ui.footerMessageInput;
if (input.value.trim()) { this.sendMessage(input.value.trim()); input.value = ''; }
});
ui.messageForm.addEventListener('submit', (e) => {
e.preventDefault();
const input = ui.messageInput;
if (input.value.trim()) { this.sendMessage(input.value.trim()); input.value = ''; }
});
ui.footerChatContainer.addEventListener('click', e => {
const tab = e.target.closest('.footer-tab-button');
if(tab && !tab.id.includes('open-chat')) this.switchChannel(tab.dataset.channel);
});
ui.tabsContainer.addEventListener('click', e => {
const tab = e.target.closest('.tab');
if(tab) this.switchChannel(tab.dataset.channel);
});
ui.openChatModalBtn.addEventListener('click', () => ui.chatModal.classList.remove('hidden'));
ui.closeChatModalBtn.addEventListener('click', () => ui.chatModal.classList.add('hidden'));
},
async sendMessage(text) {
if (!state.firebase.db || !state.player) return showToast("You must be logged in to chat.", true);
const message = {
userId: state.firebase.userId,
username: state.player.name,
text: text,
timestamp: window.firebase.serverTimestamp()
};
try {
const channelRef = window.firebase.collection(state.firebase.db, 'chat', state.chat.currentChannel, 'messages');
await window.firebase.addDoc(channelRef, message);
} catch (error) {
console.error("Error sending message:", error);
showToast("Message could not be sent.", true);
}
},
listenForMessages(channel) {
if (state.chat.unsubscribeListener) state.chat.unsubscribeListener();
const messagesRef = window.firebase.collection(state.firebase.db, 'chat', channel, 'messages');
const q = window.firebase.query(messagesRef, window.firebase.orderBy('timestamp', 'asc'), window.firebase.limitToLast(50));
state.chat.unsubscribeListener = window.firebase.onSnapshot(q, (snapshot) => {
snapshot.docChanges().forEach((change) => {
if (change.type === "added") this.renderMessage(change.doc.data());
});
}, (error) => console.error("Error listening for messages:", error));
},
renderMessage(data) {
const isCurrentUser = data.userId === state.firebase.userId;
const messageHTML = `
<div class="message-wrapper flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
<div class="chat-bubble p-2 rounded-lg max-w-[80%] ${isCurrentUser ? 'chat-bubble-user' : 'chat-bubble-other'}">
${!isCurrentUser ? `<p class="font-bold text-xs" style="color: var(--highlight-color);">${data.username}</p>` : ''}
<p class="text-sm">${data.text}</p>
</div>
</div>`;
ui.footerChatContentWrapper.innerHTML += messageHTML;
ui.chatMessages.innerHTML += messageHTML;
ui.footerChatContentWrapper.scrollTop = ui.footerChatContentWrapper.scrollHeight;
ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
},
switchChannel(newChannel) {
if (state.chat.currentChannel === newChannel) return;
state.chat.currentChannel = newChannel;
ui.footerChatContentWrapper.innerHTML = '';
ui.chatMessages.innerHTML = '';
document.querySelectorAll('.footer-tab-button, #tabs-container .tab').forEach(tab => {
tab.classList.toggle('active', tab.dataset.channel === newChannel);
});
this.listenForMessages(newChannel);
console.log(`Switched to chat channel: ${newChannel}`);
}
};
// --- Settings Manager ---
const SettingsManager = {
isInitialized: false,
init() {
if (this.isInitialized) return;
this.isInitialized = true;
this.render();
this.addEventListeners();
this.updateButtonStates();
},
render() {
ui.tabContentSettings.innerHTML = `
<div class="space-y-4">
<div class="stat-accordion-item open">
<button class="stat-accordion-header">
<h3 class="text-glow-subtle font-orbitron">UI Theme</h3>
<svg class="accordion-arrow w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
</button>
<div class="stat-accordion-content">
<p class="text-sm text-gray-400 mb-4">Select a visual theme for the game interface.</p>
<div class="flex flex-col sm:flex-row gap-4">
<button class="theme-select-btn glass-button w-full py-3 rounded-md" data-theme="aetherial-shard">Aetherial Shard</button>
<button class="theme-select-btn glass-button w-full py-3 rounded-md" data-theme="molten-core">Molten Core</button>
</div>
</div>
</div>
<div class="stat-accordion-item open">
    <button class="stat-accordion-header">
        <h3 class="text-glow-subtle font-orbitron">Map Import</h3>
        <svg class="accordion-arrow w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
    </button>
    <div class="stat-accordion-content">
        <p class="text-sm text-gray-400 mb-2">Import a map JSON file from the Map Editor.</p>
        <input type="file" id="map-import-input" accept=".json" class="hidden">
        <button id="import-map-btn" class="glass-button w-full py-2">Import Map</button>
    </div>
</div>
</div>`;
},
addEventListeners() {
ui.tabContentSettings.addEventListener('click', e => {
const themeBtn = e.target.closest('.theme-select-btn');
if (themeBtn) this.setTheme(themeBtn.dataset.theme);
const importBtn = e.target.closest('#import-map-btn');
if (importBtn) document.getElementById('map-import-input').click();
});
ui.tabContentSettings.addEventListener('change', e => {
if (e.target.id === 'map-import-input') {
    MapLoader.loadMapFile(e.target.files[0]);
}
});
},
setTheme(themeName) {
document.body.className = `theme-${themeName}`;
localStorage.setItem('geminusTheme', themeName);
this.updateButtonStates();
updateSmokeParticleColors(themeName);
},
loadTheme() {
const savedTheme = localStorage.getItem('geminusTheme') || 'aetherial-shard';
this.setTheme(savedTheme);
initSmokeParticles(savedTheme);
},
updateButtonStates() {
const currentTheme = localStorage.getItem('geminusTheme') || 'aetherial-shard';
document.querySelectorAll('.theme-select-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.theme === currentTheme);
});
}
};
// --- NEW Map Data Store ---
const MapDataStore = {
    data: null,
    assetImages: {},
    isLoaded: false,
    async load(zoneData) {
        this.isLoaded = false;
        console.log(`Loading new map: ${zoneData.zoneName}`);
        this.data = zoneData;
        
        const assetPromises = [];
        if (this.data.assetLibrary) {
            for (const assetId in this.data.assetLibrary) {
                const asset = this.data.assetLibrary[assetId];
                if (asset.imageUrl && !this.assetImages[asset.imageUrl]) {
                    assetPromises.push(new Promise((resolve) => {
                        const img = new Image();
                        img.crossOrigin = 'Anonymous';
                        img.onload = () => { this.assetImages[asset.imageUrl] = img; resolve(); };
                        img.onerror = () => { console.warn(`Failed to load asset image: ${asset.imageUrl}`); resolve(); };
                        img.src = asset.imageUrl;
                    }));
                }
            }
        }
        await Promise.all(assetPromises);
        this.isLoaded = true;
        console.log("Map data loaded and assets pre-cached.");
    },
    getAssetImage(assetId) {
        const asset = this.data.assetLibrary?.[assetId];
        return asset?.imageUrl ? this.assetImages[asset.imageUrl] : null;
    }
};
// --- NEW Map Loader ---
const MapLoader = {
    loadMapFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const mapData = JSON.parse(e.target.result);
                if (!mapData.layers || !mapData.assetLibrary) {
                    throw new Error("Invalid map file format.");
                }
                await MapDataStore.load(mapData);
                ZoneManager.loadZone(MapDataStore.data);
                showToast("Map imported successfully!");
            } catch (error) {
                console.error("Error loading map file:", error);
                showToast(`Failed to load map: ${error.message}`, true);
            }
        };
        reader.readAsText(file);
    }
};
// --- NEW Map Renderer ---
class MapRenderer {
    constructor(canvas, isMiniMap = false) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.isMiniMap = isMiniMap;
    }
    resize() {
        if (!this.canvas) return;
        const dpr = window.devicePixelRatio || 1;
        const container = this.canvas.parentElement;
        this.canvas.width = container.clientWidth * dpr;
        this.canvas.height = container.clientHeight * dpr;
        this.ctx.scale(dpr, dpr);
    }
    getHexPoints(size) {
        const points = [];
        for (let i = 0; i < 6; i++) {
            const angle_deg = 60 * i - 30;
            const angle_rad = Math.PI / 180 * angle_deg;
            points.push(size * Math.cos(angle_rad), size * Math.sin(angle_rad));
        }
        return points;
    }
    draw(mapData, playerPos) {
        if (!mapData || !mapData.layers || !playerPos) {
            const ctx = this.ctx;
            ctx.clearRect(0, 0, this.canvas.clientWidth, this.canvas.clientHeight);
            ctx.fillStyle = '#121212';
            ctx.fillRect(0, 0, this.canvas.clientWidth, this.canvas.clientHeight);
            return;
        };
        const ctx = this.ctx;
        const mapSize = mapData.mapSize;
        
        ctx.clearRect(0, 0, this.canvas.clientWidth, this.canvas.clientHeight);
        if (this.isMiniMap) {
            ctx.beginPath();
            ctx.arc(this.canvas.clientWidth / 2, this.canvas.clientHeight / 2, this.canvas.clientWidth / 2, 0, Math.PI * 2);
            ctx.clip();
        }
        
        ctx.fillStyle = '#121212';
        ctx.fillRect(0, 0, this.canvas.clientWidth, this.canvas.clientHeight);

        const TILE_SIZE = this.isMiniMap ? 15 : 64;

        ctx.save();
        
        const playerPixelX = playerPos.x * TILE_SIZE * 0.75;
        const playerPixelY = playerPos.y * TILE_SIZE * (Math.sqrt(3)/2) + (playerPos.x % 2 === 1 ? TILE_SIZE * (Math.sqrt(3)/4) : 0);
        
        if (this.isMiniMap) {
            ctx.translate(this.canvas.clientWidth / 2 - playerPixelX, this.canvas.clientHeight / 2 - playerPixelY);
            ctx.scale(2, 2); // Mini map zoom level
        } else {
            ctx.translate(this.canvas.clientWidth / 2 - playerPixelX, this.canvas.clientHeight / 2 - playerPixelY);
        }

        // --- Draw Layers ---
        mapData.layers.forEach(layer => {
            if (!layer.isVisible) return;
            layer.grid.forEach((row, y) => {
                row.forEach((tile, x) => {
                    const posX = x * TILE_SIZE * 0.75;
                    const posY = y * TILE_SIZE * (Math.sqrt(3)/2) + (x % 2 === 1 ? TILE_SIZE * (Math.sqrt(3)/4) : 0);

                    // Draw ground layer
                    if (layer.id === 'ground' && tile && tile.type !== 'empty' && tile.type !== 'wall') {
                        ctx.beginPath();
                        const points = this.getHexPoints(TILE_SIZE / 2);
                        ctx.moveTo(posX + points[0], posY + points[1]);
                        for (let i = 2; i < points.length; i += 2) {
                            ctx.lineTo(posX + points[i], posY + points[i + 1]);
                        }
                        ctx.closePath();
                        const BIOME_COLORS = { "forest": '#4A6B4A', "desert": '#D2B48C' };
                        ctx.fillStyle = BIOME_COLORS[mapData.biome] || '#696969';
                        ctx.fill();
                        ctx.strokeStyle = 'rgba(0,0,0,0.2)';
                        ctx.stroke();
                    }

                    // Draw objects layer
                    if (layer.id === 'objects' && tile) {
                        const asset = mapData.assetLibrary?.[tile.assetId];
                        const assetImage = MapDataStore.getAssetImage(tile.assetId);

                        if (assetImage) {
                            const scale = asset.scale || 1;
                            const yOffset = asset.yOffset || 0;
                            const drawSize = TILE_SIZE * scale;
                            ctx.drawImage(assetImage, posX - drawSize / 2, posY - drawSize / 2 + yOffset, drawSize, drawSize);
                        }
                    }
                });
            });
        });

        // --- Draw Player ---
        ctx.font = `${TILE_SIZE * 0.7}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('ðŸ‘¤', playerPixelX, playerPixelY);
        
        ctx.restore();
    }
}
// --- World Map Manager (NEW Mini-Map Renderer) ---
const WorldMapManager = {
    isInitialized: false,
    mapRenderer: null,
    init() {
        if (this.isInitialized) return;
        this.mapRenderer = new MapRenderer(ui.miniMapCanvas, true);
        this.isInitialized = true;
        console.log("Upgraded WorldMapManager (Mini-Map) Initialized.");
        this.mapRenderer.resize();
        this.draw();
    },
    draw() {
        if (!this.isInitialized || !state.player) return;
        this.mapRenderer.draw(MapDataStore.data, state.player.pos);
    }
};
// --- D-Pad and Keyboard Controls ---
function initControls() {
const keyElements = document.querySelectorAll('.game-key');
const setKeyState = (key, isPressed) => {
state.keyState[key] = isPressed;
document.querySelectorAll(`[data-key="${key}"]`).forEach(el => el.classList.toggle('pressed', isPressed));
};
const handleKeyPress = (key) => {
    if (!state.player || !ZoneManager.isLoaded) return;
    let dx = 0, dy = 0;
    switch(key) {
        case 'up': dy = -1; break;
        case 'down': dy = 1; break;
        case 'left': dx = -1; break;
        case 'right': dx = 1; break;
        case 'interact':
            SanctuaryManager.revivePlayer();
            return;
    }
    const newX = state.player.pos.x + dx;
    const newY = state.player.pos.y + dy;
    const mapSize = MapDataStore.data.mapSize;
    const navigationLayer = MapDataStore.data.layers.find(l => l.id === 'navigation');
    
    // Check if the new position is within map bounds and is walkable
    if (newX >= 0 && newX < mapSize.width && newY >= 0 && newY < mapSize.height && navigationLayer.grid[newY][newX].isWalkable) {
        state.player.pos.x = newX;
        state.player.pos.y = newY;
        ZoneManager.draw();
        WorldMapManager.draw();
        UIManager.updatePlayerStatusUI();
    }
};
keyElements.forEach(element => {
const key = element.dataset.key;
if (!key) return;
element.addEventListener('touchstart', (e) => { e.preventDefault(); setKeyState(key, true); handleKeyPress(key); }, { passive: false });
element.addEventListener('touchend', (e) => { e.preventDefault(); setKeyState(key, false); }, { passive: false });
element.addEventListener('mousedown', (e) => { e.preventDefault(); setKeyState(key, true); handleKeyPress(key); });
element.addEventListener('mouseup', (e) => { e.preventDefault(); setKeyState(key, false); });
element.addEventListener('mouseleave', () => { if (state.keyState[key]) setKeyState(key, false); });
});
window.addEventListener('keydown', (e) => {
if(document.activeElement.tagName === 'INPUT') return;
let key;
switch(e.key) {
case 'ArrowUp': case 'w': key = 'up'; break;
case 'ArrowDown': case 's': key = 'down'; break;
case 'ArrowLeft': case 'a': key = 'left'; break;
case 'ArrowRight': case 'd': key = 'right'; break;
case 'Enter': case ' ': key = 'interact'; break;
default: return;
}
e.preventDefault();
if (!state.keyState[key]) {
setKeyState(key, true);
handleKeyPress(key);
}
});
window.addEventListener('keyup', (e) => {
if(document.activeElement.tagName === 'INPUT') return;
let key;
switch(e.key) {
case 'ArrowUp': case 'w': key = 'up'; break;
case 'ArrowDown': case 's': key = 'down'; break;
case 'ArrowLeft': case 'a': key = 'left'; break;
case 'ArrowRight': case 'd': key = 'right'; break;
case 'Enter': case ' ': key = 'interact'; break;
default: return;
}
e.preventDefault();
setKeyState(key, false);
});
}
const ModalManager = {
show(title, contentHTML, options = {}) {
const { widthClass = 'w-11/12 max-w-lg', onContentReady } = options;
ui.modalContainer.innerHTML = `
<div class="modal-backdrop">
<div class="glass-panel p-4 rounded-lg flex flex-col ${widthClass}">
<div class="flex-shrink-0 flex justify-between items-center mb-4">
<h3 class="font-orbitron text-xl capitalize text-glow-subtle">${title}</h3>
<button id="modal-close-btn" class="text-2xl leading-none transition-colors hover:text-[var(--highlight-color)]">&times;</button>
</div>
<div id="modal-content-body" class="flex-grow overflow-y-auto custom-scrollbar">${contentHTML}</div>
</div>
</div>`;
ui.modalContainer.querySelector('#modal-close-btn').onclick = () => this.hide();
if (onContentReady) {
onContentReady(ui.modalContainer.querySelector('#modal-content-body'));
}
},
hide() {
ui.modalContainer.innerHTML = "";
}
};
const CreationManager = {
init() {
const contentHTML = `
<div class="creation-card w-full h-full flex flex-col">
<div class="flex-shrink-0">
<h1 class="text-3xl font-orbitron text-center mb-4 text-glow-label">Create Your Hero</h1>
<div class="mb-4 px-4"><input type="text" id="creation-player-name" placeholder="Enter Character Name" class="w-full text-lg editor-input"></div>
<h2 class="text-xl font-orbitron text-center mb-4 text-glow-subtle">Choose Your Race</h2>
</div>
<div id="creation-race-grid" class="flex-grow overflow-y-auto custom-scrollbar grid grid-cols-2 md:grid-cols-4 gap-2 px-4">
${Object.keys(races).map(raceId => `<div class="race-option p-3 text-center border border-transparent rounded-md cursor-pointer hover:bg-[rgba(var(--highlight-color-rgb),0.2)] font-orbitron text-glow-subtle" data-race="${raceId}">${races[raceId].raceName}</div>`).join("")}
</div>
<div class="flex-shrink-0 mt-4 px-4"><button id="finish-creation-btn" class="glass-button w-full py-3 font-bold rounded-md" disabled>Finish</button></div>
</div>`;
ModalManager.show('Create Your Character', contentHTML, {
widthClass: 'w-full max-w-3xl h-full sm:h-auto sm:max-h-[90vh]',
onContentReady: (contentDiv) => {
let selectedRace = null;
const finishBtn = contentDiv.querySelector('#finish-creation-btn');
const nameInput = contentDiv.querySelector('#creation-player-name');
const checkCanFinish = () => {
const name = nameInput.value.trim();
finishBtn.disabled = !selectedRace || name.length < 3;
};
contentDiv.querySelectorAll('.race-option').forEach(option => {
option.addEventListener('click', () => {
selectedRace = option.dataset.race;
contentDiv.querySelectorAll('.race-option').forEach(el => el.style.backgroundColor = 'transparent');
option.style.backgroundColor = `rgba(var(--highlight-color-rgb), 0.3)`;
checkCanFinish();
});
});
nameInput.addEventListener('input', checkCanFinish);
finishBtn.addEventListener('click', () => {
const playerName = nameInput.value.trim();
this.finishCreation(playerName, selectedRace);
});
},
});
},
async finishCreation(playerName, raceId) {
if (!raceId || !playerName) return;
const raceData = races[raceId];
state.player = {
name: playerName,
level: 1, xp: 0, gold: 1000,
xpToNextLevel: gddConstants.XP_BASE,
attributePoints: gddConstants.AP_PER_LEVEL,
race: raceId, // [FIX] Use the raceId (e.g., "human") for logic
archetype: raceData.archetype,
cci: raceData.coreCombatIdentity,
baseStats: {...raceData.apAllocationWeights },
derivedStats: {},
inventory: [],
equipment: {},
gems: [],
lastItemDrop: null,
lastGemDrop: null,
defeatedBosses: [],
pos: { x: 12, y: 12 },
icon: 'ðŸ‘¤'
};

// [FIX] Simplified and corrected starting gear logic
const startingWeaponTemplate = items.baseItemTemplates.find(i => i.subType === 'Sword');
const startingArmorTemplate = items.baseItemTemplates.find(i => i.subType === 'Armor');

if (startingWeaponTemplate && startingArmorTemplate) {
  const newWeapon = { instanceId: `${startingWeaponTemplate.id}_${Date.now()}_1`, baseItemId: startingWeaponTemplate.id, tier: 1, type: 'Dropper', socketedGems: [] };
  const newArmor = { instanceId: `${startingArmorTemplate.id}_${Date.now()}_2`, baseItemId: startingArmorTemplate.id, tier: 1, type: 'Dropper', socketedGems: [] };
  state.player.inventory.push(newWeapon, newArmor);
  state.player.equipment = {
    'Weapon 1': newWeapon.instanceId,
    'Armor': newArmor.instanceId,
  };
}

Systems.calculateDerivedStats(state.player);
state.player.hp = state.player.derivedStats.maxHp;
await DataManager.savePlayer(state.player);
ModalManager.hide();
GameManager.init();
},
};
const ProfileManager = {
addXp(amount) {
if (!state.player) return;
state.player.xp += amount;
CombatManager.logToGame(`You gained <span class="log-xp">${Math.floor(amount)} XP</span>!`);
while (state.player.xp >= state.player.xpToNextLevel) {
this.levelUp();
}
this.updateAllProfileUI();
DataManager.updatePlayer({ xp: state.player.xp, level: state.player.level, xpToNextLevel: state.player.xpToNextLevel, attributePoints: state.player.attributePoints });
},
addGold(amount) {
if (!state.player) return;
state.player.gold += amount;
CombatManager.logToGame(`You found <span class="log-gold">${Math.floor(amount)} Gold</span>!`);
this.updateAllProfileUI();
DataManager.updatePlayer({ gold: state.player.gold });
},
levelUp() {
state.player.xp -= state.player.xpToNextLevel;
state.player.level++;
state.player.xpToNextLevel = Math.floor(gddConstants.XP_BASE * Math.pow(gddConstants.XP_GROWTH_RATE, state.player.level));
state.player.attributePoints += gddConstants.AP_PER_LEVEL;
showToast(`You have reached Level ${state.player.level}! You gained ${gddConstants.AP_PER_LEVEL} Attribute Points.`);
Systems.calculateDerivedStats(state.player);
state.player.hp = state.player.derivedStats.maxHp;
},
spendAttributePoint(clickedAttr) {
const p = state.player;
if (p.attributePoints < gddConstants.AP_PER_LEVEL) {
showToast(`You need ${gddConstants.AP_PER_LEVEL} points to allocate.`, true);
return;
}
const racialData = races[p.race]; // [FIX] Removed .toLowerCase()
const weights = racialData.apAllocationWeights;
const totalWeight = Object.values(weights).reduce((sum, val) => sum + val, 0);
const pointsPerWeight = gddConstants.AP_PER_LEVEL / totalWeight;
for (const stat in weights) {
p.baseStats[stat] += weights[stat] * pointsPerWeight;
}
p.attributePoints -= gddConstants.AP_PER_LEVEL;
Systems.calculateDerivedStats(state.player);
StatsManager.render();
UIManager.flashStatUpdate(clickedAttr);
showToast("Attributes increased!", false);
DataManager.updatePlayer({ baseStats: p.baseStats, attributePoints: p.attributePoints });
},
updateAllProfileUI() {
UIManager.updatePlayerStatusUI();
if (CombatManager.isInitialized) CombatManager.updateCombatInfoPanel();
if (StatsManager.isInitialized) StatsManager.render();
}
};
const CombatManager = {
isInitialized: false,
currentMonster: null,
logMessages: [],
init() {
if (this.isInitialized) return;
this.isInitialized = true;
this.render();
this.addEventListeners();
this.updateCombatInfoPanel();
this.populateMonsterList(state.game.currentZoneId);
this.logMessages = ['Select a monster to begin combat.'];
this.renderLog();
},
logToGame(message) {
this.logMessages.push(message);
if (this.logMessages.length > 5) {
this.logMessages.shift();
}
this.renderLog();
},
renderLog() {
const logDisplay = document.querySelector('#tab-content-combat #combat-log-display');
if (logDisplay) {
logDisplay.innerHTML = this.logMessages.join('<br>');
logDisplay.scrollTop = logDisplay.scrollHeight;
}
},
render() {
ui.tabContentCombat.innerHTML = `
<div class="space-y-4 flex flex-col h-full">
<div id="combat-info-panel" class="w-full p-2 rounded-lg bg-black/20 border" style="border-color: var(--border-color-main)"><div id="combat-stats-container"></div></div>
<div class="combat-control-bar flex gap-2 p-2 bg-black/20 rounded-lg">
<select id="monsterSelect" class="editor-input flex-grow"></select>
<button class="glass-button px-4 py-2" id="fightBtn">FIGHT</button>
</div>
<div class="flex justify-center gap-2">
<button class="glass-button py-2 rounded-md w-1/2" id="attackBtn" style="display: none;">ATTACK</button>
<button class="glass-button py-2 rounded-md w-1/2" id="castBtn" style="display: none;">CAST</button>
<button class="glass-button py-2 rounded-md w-1/2" id="spellstrikeBtn" style="display: none;">SPELLSTRIKE</button>
</div>
<div id="combat-log-display" class="flex-grow p-2 overflow-y-auto custom-scrollbar text-sm"></div>
</div>`;
},
updateCombatInfoPanel() {
    const p = state.player;
    if (!p || !p.derivedStats) return;
    const hpPercent = (p.hp / p.derivedStats.maxHp) * 100;
    let healthClass = hpPercent < 20 ? 'text-red-500' : hpPercent < 50 ? 'text-yellow-500' : 'text-green-500';
    const createStatHTML = (label, value) => `<span class="text-glow-label">${label}:</span><span class="text-glow-subtle">${value}</span>`;
    document.getElementById('combat-stats-container').innerHTML = `
${createStatHTML('Level', p.level)}
${createStatHTML('Inv/Bags', `${p.inventory.length}/200`)}
${createStatHTML('Health', `<span class="${healthClass}">${Math.ceil(p.hp)} / ${Math.ceil(p.derivedStats.maxHp)}</span>`)}
${createStatHTML('Gem Pouch', `${p.gems.length}/${InventoryManager.MAX_GEMS}`)}
${createStatHTML('Gold', Math.floor(p.gold).toLocaleString())}
${createStatHTML('Last Item', p.lastItemDrop || 'None')}
${createStatHTML('XP', Math.floor(p.xp).toLocaleString())}
${createStatHTML('Last Gem', p.lastGemDrop || 'None')}
${createStatHTML('Next Lvl', Math.floor(p.xpToNextLevel).toLocaleString())}
<div class="col-span-4 text-glow-subtle text-center mt-1">Location: ${state.zone.name}</div>
`;
},
addEventListeners() {
const combatTab = ui.tabContentCombat;
combatTab.querySelector('#monsterSelect').addEventListener('change', (e) => this.selectMonster(e.target.value));
combatTab.querySelector('#fightBtn').addEventListener('click', () => this.fight());
combatTab.querySelector('#attackBtn').addEventListener('click', () => this.performAction('attack'));
combatTab.querySelector('#castBtn').addEventListener('click', () => this.performAction('cast'));
combatTab.querySelector('#spellstrikeBtn').addEventListener('click', () => this.performAction('spellstrike'));
},
populateMonsterList(zoneId) {
state.game.currentZoneId = zoneId;
const zoneData = bestiary[zoneId];
if (!zoneData) return;
const monsterSelect = document.getElementById('monsterSelect');
let optionsHTML = '<option value="">Select a monster...</option>';
zoneData.monsters.forEach(m => optionsHTML += `<option value="${m.id}">${m.name}</option>`);
monsterSelect.innerHTML = optionsHTML;
this.resetCombatSelection();
},
selectMonster(monsterId) {
if (!monsterId) { this.resetCombatSelection(); return; }
const zoneData = bestiary[state.game.currentZoneId];
const monsterTemplate = zoneData.monsters.find(m => m.id === monsterId);
if (!monsterTemplate) return;
const scaledMonster = Systems.MonsterScaling(monsterTemplate, zoneData.gearTier);
this.currentMonster = { ...scaledMonster, currentHP: scaledMonster.hp, stats: {ATK: scaledMonster.atk, DEF: scaledMonster.def, HP: scaledMonster.hp, XP: scaledMonster.xp, GOLD: scaledMonster.gold} };
this.logMessages = [`You are targeting ${this.currentMonster.name}.`];
this.renderLog();
this.updateButtons();
},
fight() {
if (!this.currentMonster) return showToast("Please select a monster first.", true);
state.game.combatActive = true;
this.currentMonster.currentHP = this.currentMonster.hp;
this.logMessages = [`You engage the ${this.currentMonster.name}!`];
this.renderLog();
this.updateButtons();
const result = Systems.simulateCombat(state.player, this.currentMonster);
this.logMessages.push(...result.log);
if (result.outcome === 'VICTORY') {
  const lootMessages = Systems.generateLoot(state.player, result.finalState.monster, state.game.currentZoneId);
  this.logMessages.push(...lootMessages);
  ProfileManager.updateAllProfileUI();
  DataManager.updatePlayer(state.player);
} else if (result.outcome === 'DEFEAT') {
  SanctuaryManager.handlePlayerDefeat();
}
this.endCombat();
},
performAction(actionType) {
if (!state.game.combatActive || !this.currentMonster) return;
// This logic is now handled by the simulateCombat function.
// We keep the buttons for UI but they will just trigger the full simulation.
// To make it feel more "live", we can use this to resolve one turn at a time.
const p = state.player;
const enemy = this.currentMonster;
const result = Systems.resolveCombatTurn(p, enemy);
if (result.damageDealt) {
  this.logToGame(`You hit ${enemy.name} for <span class="log-player">${result.damageDealt.toFixed(2)}</span> damage.`);
}
if (result.damageTaken) {
  this.logToGame(`${enemy.name} hits you for <span class="log-enemy">${result.damageTaken.toFixed(2)}</span> damage.`);
}
if (result.status === 'VICTORY') {
  this.logToGame(`<span class="log-enemy">${enemy.name} is dead, R.I.P.</span>`);
  const lootMessages = Systems.generateLoot(state.player, enemy, state.game.currentZoneId);
  this.logMessages.push(...lootMessages);
  this.endCombat();
  ProfileManager.updateAllProfileUI();
  DataManager.updatePlayer(state.player);
} else if (result.status === 'DEFEAT') {
  this.logToGame(`<span class="log-enemy">You have been defeated!</span>`);
  this.endCombat();
  SanctuaryManager.handlePlayerDefeat();
}
ProfileManager.updateAllProfileUI();
},
endCombat() {
state.game.combatActive = false;
this.updateButtons();
},
resetCombatSelection() {
this.currentMonster = null;
state.game.combatActive = false;
this.logMessages = ['Select a monster to begin combat.'];
this.renderLog();
this.updateButtons();
},
updateButtons() {
const [fightBtn, attackBtn, castBtn, spellstrikeBtn] = ['fightBtn', 'attackBtn', 'castBtn', 'spellstrikeBtn'].map(id => document.getElementById(id));
if(!fightBtn || !attackBtn || !castBtn || !spellstrikeBtn) return;
fightBtn.style.display = 'block';
fightBtn.disabled = !this.currentMonster || state.game.combatActive;
const canAct = this.currentMonster && state.game.combatActive;
attackBtn.style.display = (canAct && state.player.archetype === 'True Fighter') ? 'flex' : 'none';
castBtn.style.display = (canAct && state.player.archetype === 'True Caster') ? 'flex' : 'none';
spellstrikeBtn.style.display = (canAct && state.player.archetype === 'Hybrid') ? 'flex' : 'none';
}
};
// --- Sanctuary & Revival Manager ---
const SanctuaryManager = {
isPlayerDefeated: false,
handlePlayerDefeat() {
if (this.isPlayerDefeated) return;
this.isPlayerDefeated = true;
state.game.combatActive = false;
console.log("Player has been defeated.");
const goldLost = state.player.gold;
const xpLost = state.player.xp;
state.player.gold = 0;
state.player.xp = 0;
CombatManager.logToGame("<span class='log-enemy'>You have been defeated!</span>");
CombatManager.logToGame(`<span class='log-system'>You lost ${Math.floor(goldLost)} gold and ${Math.floor(xpLost)} XP.</span>`);
this.showDefeatedUI();
DataManager.updatePlayer({ hp: 0, gold: 0, xp: 0 });
},
revivePlayer() {
if (!this.isPlayerDefeated) return;
state.player.hp = state.player.derivedStats.maxHp;
this.isPlayerDefeated = false;
console.log("Player revived at the Sanctuary.");
showToast("You have been revived at the Sanctuary.", false);
this.hideDefeatedUI();
ProfileManager.updateAllProfileUI();
DataManager.updatePlayer({ hp: state.player.hp });
},
showDefeatedUI() {
const overlay = document.createElement('div');
overlay.id = 'defeat-overlay';
overlay.style.cssText = 'position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center;';
overlay.innerHTML = `
<h1 class="font-orbitron text-4xl text-red-500 mb-4">YOU HAVE FALLEN</h1>
<p class="text-gray-300 mb-8">Your echo is drawn back to the nearest sanctuary...</p>
<button id="revive-btn" class="glass-button w-1/2 max-w-xs py-4 font-bold rounded-md text-lg">Return to Sanctuary</button>`;
document.body.appendChild(overlay);
document.getElementById('revive-btn').addEventListener('click', () => this.revivePlayer());
},
hideDefeatedUI() {
const overlay = document.getElementById('defeat-overlay');
if (overlay) {
overlay.remove();
}
}
};
// --- Stats Manager ---
const StatsManager = {
isInitialized: false,
statMetadata: {
STR: { name: 'Strength', icon: 'ðŸ’ª', description: 'A gatekeeper stat for physical weapons.' },
DEX: { name: 'Dexterity', icon: 'ðŸ¹', description: 'Primary stat for Fighters & Martial Hybrids. Governs Hit/Crit Chance and WC scaling.' },
VIT: { name: 'Vitality', icon: 'â¤ï¸', description: 'Primary survivability stat. Governs Max HP and AC scaling.' },
NTL: { name: 'Intellect', icon: 'ðŸ§ ', description: 'A gatekeeper stat for spells.' },
WIS: { name: 'Wisdom', icon: 'ðŸ”®', description: 'Primary stat for Casters & Mystic Hybrids. Governs Hit/Crit Chance and SC scaling.' },
finalWC: { name: 'Weapon Class', icon: 'âš”ï¸', description: 'Your total effectiveness with physical weapons.'
},
finalSC: { name: 'Spell Class', icon: 'âœ¨', description: 'Your total effectiveness with magic.' },
finalAC: { name: 'Armor Class', icon: 'ðŸ›¡ï¸', description: 'Your total damage reduction.' },
maxHp: { name: 'Health Points', icon: 'â¤ï¸', description: 'Your life force. If it reaches zero, you are defeated.' },
hitChance: { name: 'Hit Chance', icon: 'ðŸŽ¯', description: 'The probability of successfully landing an attack on an enemy.' },
critChance: { name: 'Crit Chance', icon: 'ðŸ’¥', description: 'The probability of an attack dealing bonus critical damage.' },
},
init() {
if (this.isInitialized) return;
this.isInitialized = true;
this.render();
this.addEventListeners();
},
render() {
const statsContainer = ui.tabContentStats;
if (!statsContainer || !state.player) return;
const p = state.player;
const canUpgrade = p.attributePoints >= gddConstants.AP_PER_LEVEL;
const createStatLine = (attrKey, value, isUpgradable = false) => {
const meta = this.statMetadata[attrKey] || { name: attrKey, icon: '?', description: 'No info available.' };
const upgradeButton = isUpgradable ? `<button class="attr-btn" data-attr="${attrKey}" ${!canUpgrade ? 'disabled' : ''}>+</button>` : '';
const infoButton = `<button class="info-btn" data-title="${meta.name}" data-description="${meta.description}">i</button>`;
return `
<div class="stat-line">
<span class="stat-icon">${meta.icon}</span>
<span class="stat-name text-glow-subtle">${meta.name}</span>
<span class="stat-value text-glow-subtle" data-stat-value="${attrKey}">${value}</span>
${upgradeButton}
${infoButton}
</div>`;
};
const createHpLine = () => {
const meta = this.statMetadata.maxHp;
const hpPercent = (p.hp / p.derivedStats.maxHp) * 100;
return `
<div class="stat-line">
<span class="stat-icon">${meta.icon}</span>
<span class="stat-name text-glow-subtle">${meta.name}</span>
<div class="flex-grow flex items-center gap-2">
<div class="progress-bar-track h-3 flex-grow"><div class="progress-bar-fill h-full" style="width: ${hpPercent}%; background-color: var(--hp-color);"></div></div>
<span class="stat-value text-glow-subtle">${Math.ceil(p.hp)} / ${Math.ceil(p.derivedStats.maxHp)}</span>
</div>
<button class="info-btn" data-title="${meta.name}" data-description="${meta.description}">i</button>
</div>`;
};
statsContainer.innerHTML = `
<div id="stats-container" class="space-y-3">
<div class="stat-accordion-item open">
<button class="stat-accordion-header">
<h3 class="text-glow-subtle font-orbitron">Secondary Attributes</h3>
<svg class="accordion-arrow w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
</button>
<div class="stat-accordion-content">
${createStatLine('STR', Math.round(p.baseStats.STR), true)}
${createStatLine('DEX', Math.round(p.baseStats.DEX), true)}
${createStatLine('VIT', Math.round(p.baseStats.VIT), true)}
${createStatLine('NTL', Math.round(p.baseStats.NTL), true)}
${createStatLine('WIS', Math.round(p.baseStats.WIS), true)}
<div class="stat-line mt-2">
<span class="stat-icon">ðŸ’Ž</span>
<span class="stat-name text-glow-subtle">Unspent Points</span>
<span id="unspent-points-value" class="stat-value text-glow-label">${p.attributePoints || 0}</span>
</div>
</div>
</div>
<div class="stat-accordion-item">
<button class="stat-accordion-header">
<h3 class="text-glow-subtle font-orbitron">Primary Combat Stats</h3>
<svg class="accordion-arrow w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
</button>
<div class="stat-accordion-content">
${createStatLine('finalWC', p.derivedStats.WC.toFixed(2))}
${createStatLine('finalSC', p.derivedStats.SC.toFixed(2))}
${createStatLine('finalAC', p.derivedStats.AC.toFixed(2))}
</div>
</div>
<div class="stat-accordion-item">
<button class="stat-accordion-header">
<h3 class="text-glow-subtle font-orbitron">Derived Stats</h3>
<svg class="accordion-arrow w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
</button>
<div class="stat-accordion-content">
${createHpLine()}
${createStatLine('hitChance', `${p.derivedStats.hitChance.toFixed(2)}%`)}
${createStatLine('critChance', `${p.derivedStats.critChance.toFixed(2)}%`)}
</div>
</div>
</div>`;
},
addEventListeners() {
const statsContainer = ui.tabContentStats;
statsContainer.addEventListener('click', (e) => {
const header = e.target.closest('.stat-accordion-header');
const attrBtn = e.target.closest('.attr-btn');
const infoBtn = e.target.closest('.info-btn');
if (header) {
header.parentElement.classList.toggle('open');
} else if (attrBtn) {
ProfileManager.spendAttributePoint(attrBtn.dataset.attr);
} else if (infoBtn) {
this.showStatInfo(infoBtn.dataset.title, infoBtn.dataset.description);
}
});
document.getElementById('stat-info-backdrop').addEventListener('click', () => this.hideStatInfo());
},
showStatInfo(title, description) {
const modal = document.getElementById('stat-info-modal');
modal.querySelector('#stat-info-title').textContent = title;
modal.querySelector('#stat-info-description').textContent = description;
modal.style.display = 'flex';
},
hideStatInfo() {
document.getElementById('stat-info-modal').style.display = 'none';
}
};
const InventoryManager = {
isInitialized: false,
MAX_GEMS: 200,
filterState: { category: 'All', subType: 'All', tier: 'All', quality: 'All', sortBy: 'tier', order: 'desc' },
inventoryBags: {
'Weapon Chest': ['Weapons'],
'Bag of Gear': ['Armor'],
'Jewelry Box': ['Amulet', 'Ring', 'Accessory'],
'Spell Satchel': ['Spells'],
},
init() {
if (this.isInitialized) return;
this.isInitialized = true;
this.renderInventoryTab();
this.addEventListeners();
this.populateFilterOptions();
this.updateAllViews();
},
renderInventoryTab() {
const inventoryContainer = ui.tabContentInventory;
let bagsHTML = "";
for (const bagName in this.inventoryBags) {
bagsHTML += `
<div class="stat-accordion-item open" data-bag-container="${bagName}">
<button class="stat-accordion-header">
<h3 class="text-glow-subtle font-orbitron">${bagName} <span id="inventory-${bagName.replace(/\s+/g, '-')}-count" class="text-xs text-gray-400 font-sans"></span></h3>
<svg class="accordion-arrow w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
</button>
<div class="stat-accordion-content !p-2">
<div class="inventory-grid" data-bag-name="${bagName}"></div>
</div>
</div>`;
}
inventoryContainer.innerHTML = `
<div id="inventory-sort-container" class="mb-2">
<div class="stat-accordion-item open">
<button class="stat-accordion-header">
<h3 class="text-glow-subtle font-orbitron"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9M3 12h9m-9 4h6"></path></svg>Sort & Filter</h3>
<svg class="accordion-arrow w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
</button>
<div class="stat-accordion-content !p-2">
<div class="grid grid-cols-2 md:grid-cols-4 gap-2">
<div><label class="text-xs text-gray-400">Category</label><select id="inventory-filter-category-select" class="editor-input !w-full !text-xs"></select></div>
<div><label class="text-xs text-gray-400">Sub-Type</label><select id="inventory-filter-subtype-select" class="editor-input !w-full !text-xs"></select></div>
<div><label class="text-xs text-gray-400">Tier</label><select id="inventory-filter-tier-select" class="editor-input !w-full !text-xs"></select></div>
<div><label class="text-xs text-gray-400">Quality</label><select id="inventory-filter-quality-select" class="editor-input !w-full !text-xs"></select></div>
</div>
<div class="grid grid-cols-2 gap-2 mt-2 border-t border-gray-700 pt-2">
<div><label class="text-xs text-gray-400">Sort By</label><select id="inventory-sort-by-select" class="editor-input !w-full !text-xs"><option value="tier">Tier</option><option value="name">Name</option><option value="type">Type</option></select></div>
<div><label class="text-xs text-gray-400">Order</label><select id="inventory-sort-order-select" class="editor-input !w-full !text-xs"><option value="desc">Descending</option><option value="asc">Ascending</option></select></div>
</div>
</div>
</div>
</div>
${bagsHTML}
<div class="stat-accordion-item open">
<button class="stat-accordion-header">
<h3 class="text-glow-subtle font-orbitron">Gem Pouch <span id="inventory-gem-pouch-count" class="text-xs text-gray-400 font-sans"></span></h3>
<svg class="accordion-arrow w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
</button>
<div class="stat-accordion-content !p-2">
<div class="gem-pouch-grid"></div>
</div>
</div>`;
},
addEventListeners() {
const inventoryContainer = ui.tabContentInventory;
inventoryContainer.addEventListener('click', e => {
const slot = e.target.closest('.inventory-slot');
const gemItem = e.target.closest('.gem-item');
const header = e.target.closest('.stat-accordion-header');
if (slot?.dataset.instanceId) this.showItemActionModal(slot.dataset.instanceId, null);
else if (gemItem?.dataset.gemId) this.showItemActionModal(null, gemItem.dataset.gemId);
else if (header) header.parentElement.classList.toggle('open');
});
inventoryContainer.addEventListener('change', e => {
const targetId = e.target.id;
if (targetId.startsWith('inventory-filter-') || targetId.startsWith('inventory-sort-')) {
this.filterState.category = document.getElementById('inventory-filter-category-select').value;
this.filterState.subType = document.getElementById('inventory-filter-subtype-select').value;
this.filterState.tier = document.getElementById('inventory-filter-tier-select').value;
this.filterState.quality = document.getElementById('inventory-filter-quality-select').value;
this.filterState.sortBy = document.getElementById('inventory-sort-by-select').value;
this.filterState.order = document.getElementById('inventory-sort-order-select').value;
if (targetId === 'inventory-filter-category-select') {
this.populateSubTypeFilter();
this.filterState.subType = 'All';
document.getElementById('inventory-filter-subtype-select').value = 'All';
}
this.renderInventoryBags();
}
});
document.getElementById('item-action-modal-backdrop').addEventListener('click', () => this.hideItemActionModal());
},
populateFilterOptions() {
document.getElementById('inventory-filter-category-select').innerHTML = ['All', ...Object.keys(this.inventoryBags)].map(c => `<option value="${c}">${c}</option>`).join("");
document.getElementById('inventory-filter-tier-select').innerHTML = '<option value="All">All Tiers</option>' + Array.from({length: 20}, (_, i) => `<option value="${i+1}">Tier ${i+1}</option>`).join("");
document.getElementById('inventory-filter-quality-select').innerHTML = ['All', 'Dropper', 'Shadow', 'Echo'].map(q => `<option value="${q}">${q}</option>`).join("");
this.populateSubTypeFilter();
},
populateSubTypeFilter() {
const category = document.getElementById('inventory-filter-category-select').value;
const subTypeSelect = document.getElementById('inventory-filter-subtype-select');
let subTypes = new Set();
const itemsToScan = items.baseItemTemplates.filter(item => {
if (category === 'All') return true;
return this.inventoryBags[category]?.includes(item.type);
});
itemsToScan.forEach(item => subTypes.add(item.subType || item.type));
subTypeSelect.innerHTML = ['All', ...Array.from(subTypes).sort()].map(s => `<option value="${s}">${s}</option>`).join("");
},
renderInventoryBags() {
const equippedIds = Object.values(state.player.equipment).filter(Boolean);
let unequippedItems = state.player.inventory.filter(item => !equippedIds.includes(item.instanceId));
const { category, subType, tier, quality} = this.filterState;
const filteredItems = unequippedItems.filter(item => {
const base = items.baseItemTemplates.find(b => b.id === item.baseItemId);
if (!base) return false;
if (category !== 'All' && !this.inventoryBags[category]?.includes(base.type)) return false;
if (subType !== 'All' && (base.subType || base.type) !== subType) return false;
if (tier !== 'All' && item.tier.toString() !== tier) return false;
if (quality !== 'All' && item.type !== quality) return false;
return true;
});
filteredItems.sort((a, b) => {
const baseA = items.baseItemTemplates.find(item => item.id === a.baseItemId);
const baseB = items.baseItemTemplates.find(item => item.id === b.baseItemId);
let compareA = (this.filterState.sortBy === 'name') ? baseA.name : (this.filterState.sortBy === 'type' ? baseA.type : a.tier);
let compareB = (this.filterState.sortBy === 'name') ? baseB.name : (this.filterState.sortBy === 'type' ? baseB.type : b.tier);
if (compareA < compareB) return this.filterState.order === 'asc' ? -1 : 1;
if (compareA > compareB) return this.filterState.order === 'asc' ? 1 : -1;
return 0;
});
document.querySelectorAll('#tab-content-inventory .inventory-grid').forEach(grid => grid.innerHTML = "");
filteredItems.forEach(item => {
const base = items.baseItemTemplates.find(b => b.id === item.baseItemId);
for (const bagName in this.inventoryBags) {
if (this.inventoryBags[bagName].includes(base.type)) {
const grid = document.querySelector(`#tab-content-inventory .inventory-grid[data-bag-name="${bagName}"]`);
if (grid) {
let overlaysHTML = this.generateGemOverlaysHTML(item);
grid.innerHTML += `
<div class="inventory-slot" data-instance-id="${item.instanceId}">
${overlaysHTML}
<img src="${base.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/1f2937/ffffff?text=ERR';">
<span class="item-tier-label">T${item.tier}</span>
</div>`;
}
break;
}
}
});
this.updateCounts();
},
updateAllViews() {
this.renderInventoryBags();
this.renderGemPouch();
this.updateCounts();
},
updateCounts() {
const equippedIds = Object.values(state.player.equipment).filter(Boolean);
const unequippedItems = state.player.inventory.filter(item => !equippedIds.includes(item.instanceId));
for (const bagName in this.inventoryBags) {
const count = unequippedItems.filter(item => {
const baseItem = items.baseItemTemplates.find(b => b.id === item.baseItemId);
return baseItem && this.inventoryBags[bagName].includes(baseItem.type);
}).length;
document.getElementById(`inventory-${bagName.replace(/\s+/g, '-')}-count`).textContent = `(${count})`;
}
document.getElementById('inventory-gem-pouch-count').textContent = `(${state.player.gems.length}/${this.MAX_GEMS})`;
},
renderGemPouch() {
const grid = document.querySelector('#tab-content-inventory .gem-pouch-grid');
if (!grid) return;
grid.innerHTML = state.player.gems.map(gemInfo => {
const gem = gems.standard[gemInfo.id];
return `
<div class="gem-item" data-gem-id="${gemInfo.id}"><img src="https://placehold.co/40x40/1f2937/ffffff?text=${gem.name.slice(0,2)}" class="w-10 h-10"><span class="item-label text-glow-subtle">${gem.name.slice(0,3)}${gemInfo.grade}</span></div>`;
}).join("");
},
showItemActionModal(instanceId, gemId) {
const modalBody = document.getElementById('item-action-modal-body');
let contentHTML = "", actionButtonHTML = "", actionHandler = null;
if (instanceId) {
const item = state.player.inventory.find(i => i.instanceId === instanceId);
if (!item) return;
const baseItem = items.baseItemTemplates.find(b => b.id === item.baseItemId);
const isEquipped = Object.values(state.player.equipment).includes(instanceId);
let gemListHTML = item.socketedGems?.filter(g => g).length > 0 ? `<div class="item-gem-list">${item.socketedGems.map(gemInfo => {
if (!gemInfo) return "";
const gemData = gems.standard[gemInfo.id];
return `<div class="item-gem-entry"><span class="item-gem-name">${gemData.name.slice(0,3)}${gemInfo.grade}</span><span class="item-gem-effect">${gemData.effect || 'N/A'}</span></div>`;
}).join("")}</div>` : "";
contentHTML = `<div class="item-name text-glow-subtle">${baseItem.name}</div><div class="item-type">Tier ${item.tier} ${baseItem.type}</div>${gemListHTML}`;
actionButtonHTML = `<button id="item-action-button" class="glass-button w-full py-2 rounded-md mt-4">${isEquipped ? 'Unequip' : 'Equip'}</button>`;
actionHandler = () => isEquipped ? this.unequipItem(instanceId) : this.equipItem(instanceId);
} else if (gemId) {
const gemInfo = state.player.gems.find(g => g.id === gemId);
if (!gemInfo) return;
const gemData = gems.standard[gemId];
contentHTML = `<div class="item-name text-glow-subtle">${gemData.name}</div><div class="item-type">Grade ${gemInfo.grade} Gem</div><div class="item-stat"><span class="item-stat-label">Effect: </span><span class="item-stat-value text-glow-label">${gemData.effect || 'N/A'}</span></div>`;
}
modalBody.innerHTML = contentHTML + actionButtonHTML;
document.getElementById('item-action-modal-content').style.display = 'block';
document.getElementById('item-action-modal-backdrop').style.display = 'block';
const actionButton = document.getElementById('item-action-button');
if (actionButton && actionHandler) actionButton.addEventListener('click', actionHandler, { once: true });
},
hideItemActionModal() {
document.getElementById('item-action-modal-content').style.display = 'none';
document.getElementById('item-action-modal-backdrop').style.display = 'none';
},
// [FIX] Replaced broken equipItem logic with a functional version
equipItem(instanceId) {
    const item = state.player.inventory.find(i => i.instanceId === instanceId);
    if (!item) return;
    const baseItem = items.baseItemTemplates.find(b => b.id === item.baseItemId);
    if (!baseItem) return;
    
    const slotType = baseItem.type;
    // Find an empty slot of the correct type, or the first slot if no empty ones are available
    let targetSlotName = equipmentSlotConfig.find(slot => slot.type === slotType && !state.player.equipment[slot.name])?.name;

    if (!targetSlotName) {
        targetSlotName = equipmentSlotConfig.find(slot => slot.type === slotType)?.name;
    }

    if (!targetSlotName) {
        showToast(`No available slot for ${slotType}.`, true);
        return;
    }
    
    // If the target slot is already filled, unequip the existing item first
    if (state.player.equipment[targetSlotName]) {
        this.unequipItem(state.player.equipment[targetSlotName], false);
    }
    
    state.player.equipment[targetSlotName] = instanceId;
    
    this.hideItemActionModal();
    this.updateAllViews();
    if (EquipmentManager.isInitialized) EquipmentManager.renderEquipmentView();
    Systems.calculateDerivedStats(state.player);
    showToast(`${baseItem.name} equipped.`, false);
    DataManager.updatePlayer({ equipment: state.player.equipment });
},
unequipItem(instanceId, showModalUpdate = true) {
const slotName = Object.keys(state.player.equipment).find(key => state.player.equipment[key] === instanceId);
if (!slotName) return;
const item = state.player.inventory.find(i => i.instanceId === instanceId);
const baseItem = items.baseItemTemplates.find(b => b.id === item.baseItemId);
state.player.equipment[slotName] = null;
this.hideItemActionModal();
if (showModalUpdate) {
this.updateAllViews();
if (EquipmentManager.isInitialized) EquipmentManager.renderEquipmentView();
}
Systems.calculateDerivedStats(state.player);
showToast(`${baseItem.name} unequipped.`, false);
DataManager.updatePlayer({ equipment: state.player.equipment });
},
generateGemOverlaysHTML(item) {
let overlaysHTML = '';
if (item.socketedGems && item.socketedGems.length > 0) {
overlaysHTML += '<div class="gem-overlays-container">';
const gem1 = item.socketedGems[0];
const gem2 = item.socketedGems[1];
if (gem1) {
const gemData1 = gems.standard[gem1.id];
overlaysHTML += `<div class="gem-overlay ${gemData1.category.toLowerCase()}">${gemData1.name.slice(0,3)}</div>`;
}
if (!gem1 && gem2) overlaysHTML += '<div></div>';
if (gem2) {
const gemData2 = gems.standard[gem2.id];
overlaysHTML += `<div class="gem-overlay ${gemData2.category.toLowerCase()}">${gemData2.name.slice(0,3)}</div>`;
}
overlaysHTML += '</div>';
}
return overlaysHTML;
}
};
const EquipmentManager = {
isInitialized: false,
init() {
if(this.isInitialized) return;
this.isInitialized = true;
this.renderEquipmentView();
this.addEventListeners();
},
renderEquipmentView() {
const equipmentContainer = ui.tabContentEquipment;
if (!equipmentContainer) return;
const slotsHTML = equipmentSlotConfig.map(slot => { // [FIX] Use the new config constant
const instanceId = state.player.equipment[slot.name];
const item = state.player.inventory.find(i => i.instanceId === instanceId);
let contentHTML = '<span class="text-xs text-gray-500">Empty</span>';
if (item) {
const base = items.baseItemTemplates.find(b => b.id === item.baseItemId);
let overlaysHTML = InventoryManager.generateGemOverlaysHTML(item);
contentHTML = `
${overlaysHTML}
<img src="${base.imageUrl}" class="h-12 w-12 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/48x48/1f2937/ffffff?text=ERR';">
<span class="item-tier-label">T${item.tier}</span>`;
}
return`
<div class="equipment-slot-wrapper">
<div class="equipment-slot-title font-orbitron text-glow-subtle"><span>${slot.name}</span></div>
<div class="equipment-slot-content" data-slot-name="${slot.name}" data-instance-id="${instanceId || ""}">${contentHTML}</div>
</div>`;
}).join("");
equipmentContainer.innerHTML = `<div class="equipment-grid">${slotsHTML}</div>`;
},
addEventListeners() {
const equipmentContainer = ui.tabContentEquipment;
equipmentContainer.addEventListener('click', e => {
const slot = e.target.closest('.equipment-slot-content');
if (slot && slot.dataset.instanceId) {
InventoryManager.showItemActionModal(slot.dataset.instanceId, null);
}
});
},
};
const UIManager = {
updatePlayerStatusUI() {
if (!state.player) return;
const p = state.player;
const raceData = races[p.race]; // Look up race data using the ID
const archetypeAbbr = { 'True Fighter': 'FTR', 'True Caster': 'CST', 'Hybrid': 'HYB' }[p.archetype] || 'N/A';
const cciParts = (p.cci || 'N/A').split('/');
const specialization = cciParts[0] === cciParts[1] ? cciParts[0] : p.cci;
const aspecValue = `${archetypeAbbr}-${specialization}`;
ui.playerNameLevelValue.textContent = `${p.name} Lvl: ${p.level}`;
ui.playerRaceValue.textContent = raceData ? raceData.raceName : p.race; // [FIX] Display the full name
ui.playerAspecValue.textContent = aspecValue;
ui.zoneNameValue.textContent = state.zone.name;
ui.playerCoordsValue.textContent = `(${p.pos.x},${p.pos.y})`;
},
flashStatUpdate(attr) {
const statValueEl = document.querySelector(`[data-stat-value="${attr}"]`);
const unspentPointsEl = document.getElementById('unspent-points-value');
if (statValueEl) { statValueEl.classList.add('flash-update'); setTimeout(() => statValueEl.classList.remove('flash-update'), 500); }
if (unspentPointsEl) { unspentPointsEl.classList.add('flash-update'); setTimeout(() => unspentPointsEl.classList.remove('flash-update'), 500); }
}
};
const GameManager = {
isInitialized: false,
init() {
    if (this.isInitialized) return;
    this.isInitialized = true;
    ui.gameHudScreen.style.display = 'block';
    Systems.calculateDerivedStats(state.player);
    ProfileManager.updateAllProfileUI();
    
    // Initialize map and control systems
    WorldMapManager.init();
    ZoneManager.init();
    initControls();
    this.setupEventListeners();
    
    // Check for embedded map data
    if (embeddedZoneData) {
        MapDataStore.load(embeddedZoneData).then(() => {
            ZoneManager.loadZone(MapDataStore.data);
            this.switchTab('equipment'); // Default tab if map exists
        });
    } else {
        console.log("No embedded zone data found. Please import a map via the Settings tab.");
        this.switchTab('settings'); // Switch to settings if no map
        setTimeout(() => showToast("Import a map from the Map Editor to start.", false), 1000);
    }
    
    LayoutManager.init();
    ChatManager.init();
    console.log("Game Initialized. Player loaded:", state.player);
},
setupEventListeners() {
ui.mainTabsContainer.addEventListener('click', (e) => {
if (state.ui.isLayoutEditMode || !e.target.classList.contains('main-tab-button')) return;
this.switchTab(e.target.dataset.tab);
});
ui.focusModeBtn.addEventListener('click', () => {
state.ui.isFocused = !state.ui.isFocused;
ui.mainContent.classList.toggle('focused', state.ui.isFocused);
});
ui.toggleControlsBtn.addEventListener('click', () => ui.footerSection.classList.toggle('controls-hidden'));
ui.layoutEditBtn.addEventListener('click', () => LayoutManager.toggleEditMode());
ui.miniMapPanel.addEventListener('click', () => {
ui.fullScreenMapOverlay.classList.remove('hidden');
ZoneManager.resizeCanvas();
ZoneManager.draw();
});
ui.mapCloseBtn.addEventListener('click', () => ui.fullScreenMapOverlay.classList.add('hidden'));
},
switchTab(tabName) {
document.querySelectorAll('#main-tabs-container .main-tab-button, #main-tab-content .main-tab-panel').forEach(el => el.classList.remove('active'));
const tabButton = document.querySelector(`.main-tab-button[data-tab="${tabName}"]`);
const tabPanel = document.getElementById(`tab-content-${tabName}`);
if (tabButton) tabButton.classList.add('active');
if (tabPanel) tabPanel.classList.add('active');
const managers = {
combat: CombatManager, stats: StatsManager, inventory: InventoryManager,
equipment: EquipmentManager, settings: SettingsManager
};
if (managers[tabName] && !managers[tabName].isInitialized) {
managers[tabName].init();
}
}
};
const LayoutManager = {
selectedItem: null, initialPinchDistance: 0, resizingElement: null,
init() { this.loadLayout(); this.addEventListeners(); },
toggleEditMode() {
state.ui.isLayoutEditMode = !state.ui.isLayoutEditMode;
document.getElementById('layout-container').classList.toggle('layout-edit-mode', state.ui.isLayoutEditMode);
if (!state.ui.isLayoutEditMode) {
if (this.selectedItem) { this.selectedItem.classList.remove('layout-selected'); this.selectedItem = null; }
this.saveLayout();
showToast('Layout Saved!');
} else {
this.showTutorial();
showToast('Layout Edit: Tap to select, tap again to swap.');
}
},
addEventListeners() {
const container = document.getElementById('layout-container');
container.addEventListener('click', e => this.handleTap(e));
container.addEventListener('touchstart', e => this.handleTouchStart(e), { passive: false });
container.addEventListener('touchmove', e => this.handleTouchMove(e), { passive: false });
container.addEventListener('touchend', e => this.handleTouchEnd(e));
},
handleTap(e) {
if (!state.ui.isLayoutEditMode) return;
const tappedTab = e.target.closest('.tappable-tab');
if (tappedTab) { e.preventDefault(); e.stopPropagation(); this.processSelection(tappedTab, 'tab'); return; }
const tappedSection = e.target.closest('.tappable-section');
if (tappedSection) this.processSelection(tappedSection, 'section');
},
processSelection(element, type) {
if (!this.selectedItem) {
this.selectedItem = element;
element.classList.add('layout-selected');
} else {
if (this.selectedItem === element) {
element.classList.remove('layout-selected');
this.selectedItem = null;
} else if (this.selectedItem.classList.contains(`tappable-${type}`) && element.classList.contains(`tappable-${type}`)) {
const parent = element.parentNode;
const selectedNext = this.selectedItem.nextSibling;
parent.insertBefore(this.selectedItem, element);
parent.insertBefore(element, selectedNext);
this.selectedItem.classList.remove('layout-selected');
this.selectedItem = null;
} else {
this.selectedItem.classList.remove('layout-selected');
this.selectedItem = element;
element.classList.add('layout-selected');
}
}
},
handleTouchStart(e) {
if (!state.ui.isLayoutEditMode || e.touches.length !== 2) return;
this.resizingElement = e.target.closest('.tappable-section');
if (!this.resizingElement) return;
e.preventDefault();
this.initialPinchDistance = this.getPinchDistance(e.touches);
this.resizingElement.style.transition = 'none';
},
handleTouchMove(e) {
if (!state.ui.isLayoutEditMode || e.touches.length !== 2 || !this.resizingElement) return;
e.preventDefault();
const newPinchDistance = this.getPinchDistance(e.touches);
const scale = newPinchDistance / this.initialPinchDistance;
let newHeight = this.resizingElement.offsetHeight * scale;
const minHeight = 80;
const maxHeight = ui.layoutContainer.offsetHeight * 0.7;
newHeight = Math.max(minHeight, Math.min(newHeight, maxHeight));
this.resizingElement.style.flexBasis = `${newHeight}px`;
this.resizingElement.style.flexGrow = '0';
this.resizingElement.style.flexShrink = '0';
this.initialPinchDistance = newPinchDistance;
},
handleTouchEnd(e) {
if (this.resizingElement) {
this.resizingElement.style.transition = '';
this.resizingElement = null;
this.initialPinchDistance = 0;
}
},
getPinchDistance(touches) {
return Math.hypot(touches[0].pageX - touches[1].pageX, touches[0].pageY - touches[1].pageY);
},
saveLayout() {
const layoutData = {
sections: [],
tabs: [...document.querySelectorAll('.tappable-tab')].map(el => el.dataset.tab)
};
document.querySelectorAll('.tappable-section').forEach(el => {
layoutData.sections.push({ id: el.id, size: el.style.flexBasis || null });
});
localStorage.setItem('geminusLayout', JSON.stringify(layoutData));
},
loadLayout() {
const savedLayout = JSON.parse(localStorage.getItem('geminusLayout'));
if (savedLayout) {
const sectionContainer = document.getElementById('layout-container');
const sectionMap = new Map([...sectionContainer.children].map(child => [child.id, child]));
savedLayout.sections.forEach(sectionData => {
const el = sectionMap.get(sectionData.id);
if(el) {
sectionContainer.appendChild(el);
if (sectionData.size) {
el.style.flexBasis = sectionData.size;
el.style.flexGrow = '0'; el.style.flexShrink = '0';
}
}
});
const tabContainer = document.getElementById('main-tabs-container');
savedLayout.tabs.forEach(tab => {
const el = tabContainer.querySelector(`[data-tab="${tab}"]`);
if(el) tabContainer.appendChild(el);
});
}
},
showTutorial() {
if (localStorage.getItem('geminusEditorTutorialSeen')) return;
const tutorialHTML = `
<div id="editor-tutorial-overlay" class="absolute inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 text-center text-white" style="border-radius: 0.5rem;">
<div class="backdrop-blur-sm p-6 rounded-lg glass-panel !animation-name:none">
<h3 class="font-orbitron text-2xl mb-4 text-glow-label">Layout Editor Guide</h3>
<p class="mb-2">Tap a section, then tap another to <strong class="text-[var(--highlight-color)]">swap</strong>.</p>
<p>Use a two-finger <strong class="text-[var(--highlight-color)]">pinch gesture</strong> to resize.</p>
<button id="close-tutorial-btn" class="glass-button px-6 py-2 mt-6">Got It</button>
</div>
</div>`;
ui.layoutContainer.insertAdjacentHTML('beforeend', tutorialHTML);

const closeTutorial = (e) => {
e.preventDefault(); e.stopPropagation();
document.getElementById('editor-tutorial-overlay').remove();
localStorage.setItem('geminusEditorTutorialSeen', 'true');
};

const closeBtn = document.getElementById('close-tutorial-btn');
closeBtn.addEventListener('touchend', closeTutorial, { once: true });
closeBtn.addEventListener('click', closeTutorial, { once: true });
}
};
const ZoneManager = {
    isInitialized: false,
    mapRenderer: null,
    isLoaded: false,
    init() {
        if (this.isInitialized) return;
        this.mapRenderer = new MapRenderer(ui.zoneCanvas, false);
        this.isInitialized = true;
        console.log("Zone Manager Initialized.");
    },
    loadZone(zoneData) {
        this.isLoaded = false;
        console.log(`Loading zone: ${zoneData.zoneName}`);
        state.zone.name = zoneData.zoneName;
        document.getElementById('world-map-title').textContent = zoneData.zoneName;

        if (state.player && zoneData.spawnPoints && zoneData.spawnPoints.length > 0) {
            state.player.pos.x = zoneData.spawnPoints[0].x;
            state.player.pos.y = zoneData.spawnPoints[0].y;
        }

        this.isLoaded = true;
        this.resizeCanvas();
        this.draw();
        WorldMapManager.draw();
        UIManager.updatePlayerStatusUI();
    },
    resizeCanvas() {
        this.mapRenderer.resize();
    },
    draw() {
        if (!state.player) return;
         // Draw map data if it's loaded, otherwise, it will draw a blank canvas
        this.mapRenderer.draw(MapDataStore.data, state.player.pos);
    }
};
// --- UI Elements ---
const ui = {};
document.querySelectorAll('[id]').forEach(el => {
const camelCaseId = el.id.replace(/-(\w)/g, (m, g) => g.toUpperCase());
ui[camelCaseId] = el;
});

// --- Main Initialization ---
function main() {
SettingsManager.loadTheme();
DataManager.init();
}
document.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>
